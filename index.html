<!DOCTYPE html>
<html lang="pt-br">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>89 anos da Tia Am√©lia üéâ | Churrasco Comunit√°rio</title>
  <meta name="description" content="Organizador do churrasco comunit√°rio da Tia Am√©lia (89). Reserve presentes, cadastre o que vai levar e acompanhe o progresso em tempo real." />
  <link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='.9em' font-size='90'>üéÇ</text></svg>">
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    :root{
      --fg:#111827;--fg-2:#374151;--muted:#6b7280;--brand:#2563eb;--card:#ffffff;--border:#e5e7eb;
    }
    body{color:var(--fg)}
    .card{border:1px solid var(--border);border-radius:1rem;background:var(--card)}
    .btn{border-radius:.75rem;padding:.625rem .9rem;font-weight:700;min-height:44px}
    .btn-primary{background:var(--brand);color:#fff}
    .btn-ghost{background:#fff;border:1px solid var(--border)}
    .btn-pill{border-radius:9999px}
    .input{width:100%;border:1px solid var(--border);border-radius:.75rem;padding:.6rem .8rem}
    .chip{border:1px solid var(--border);border-radius:9999px;padding:.35rem .7rem;font-size:.85rem}
    .chip[aria-pressed="true"]{background:#eff6ff;border-color:var(--brand);color:var(--brand)}
    .tab{padding:.5rem .9rem;border-radius:.75rem;border:1px solid var(--border)}
    .tab[aria-selected="true"]{background:#111827;color:#fff;border-color:#111827}

    /* Modo Vov√≥: fontes maiores, bot√µes altos, esconde avan√ßados */
    .grandma html, .grandma body{font-size:115%}
    .grandma .btn{min-height:52px}
    .grandma .hide-in-grandma{display:none !important}
    .grandma #toggleItemsHeight, .grandma #toggleItemsHeightTop,
    .grandma #toggleGiftsHeight, .grandma #toggleGiftsHeightTop{display:none !important}

    /* Alto contraste */
    .high-contrast{
      --fg:#000;--fg-2:#000;--muted:#111;--card:#fff;--border:#000;--brand:#000;
    }
    .high-contrast .btn-primary{background:#000;color:#fff}

    /* Reduzir movimento: desliga anima√ß√µes visuais que n√£o s√£o essenciais */
    .reduce-motion *{animation:none !important; transition:none !important}

    /* Rolagens capadas + iOS smooth */
    #giftsList, #itemsList { scroll-behavior:smooth; -webkit-overflow-scrolling:touch; }

    /* Fade de rodap√© (listas com rolagem) */
    .fade-bottom {
      position: absolute; left: 1rem; right: 1rem; bottom: 1rem;
      height: 36px; pointer-events: none; display: none;
      background: linear-gradient(to bottom, rgba(255,255,255,0), #ffffff);
      border-bottom-left-radius: 1rem; border-bottom-right-radius: 1rem;
    }

    /* Scrollbar discreta (Chromium/WebKit) */
    #giftsList::-webkit-scrollbar, #itemsList::-webkit-scrollbar { width: 8px; }
    #giftsList::-webkit-scrollbar-thumb, #itemsList::-webkit-scrollbar-thumb { background:#d1d5db; border-radius:8px; }

    /* Skeletons */
    .skeleton{position:relative;overflow:hidden;background:#f3f4f6;border-radius:1rem}
    .skeleton::after{
      content:"";position:absolute;inset:0;
      background:linear-gradient(90deg,rgba(255,255,255,0),rgba(255,255,255,.8),rgba(255,255,255,0));
      transform:translateX(-100%);animation:shimmer 1.2s infinite;
    }
    @keyframes shimmer{100%{transform:translateX(100%)}}

    /* CTA flutuante (mobile) */
    #floatingJoinBtn{ box-shadow:0 10px 20px rgba(37,99,235,.25); }

    /* Toast */
    #toast{position:fixed;left:0;right:0;bottom:12px;display:none;z-index:60}

    /* Destaque da Leitura Guiada */
    .guided{outline:3px solid #f59e0b; outline-offset:3px; border-radius:.75rem}
  </style>
</head>
<body class="min-h-screen" style="background:linear-gradient(to bottom,#f0f6ff,#ffffff,#fff5f5)">
  <!-- HEADER -->
  <header class="sticky top-0 z-30 bg-white/80 backdrop-blur border-b">
    <div class="max-w-6xl mx-auto px-4 py-3 grid grid-cols-2 sm:grid-cols-[auto_1fr_auto] items-center gap-3">
      <div class="flex items-center gap-2">
        <div class="text-2xl">üéâ</div>
        <div class="leading-tight">
          <div class="text-sm sm:text-base font-bold">89 anos da Tia Am√©lia</div>
          <div id="eventDateText" class="text-xs sm:text-sm text-gray-700">‚Äì</div>
        </div>
      </div>

      <div class="hidden sm:block"></div>

      <!-- Barras de autentica√ß√£o -->
      <div id="authBarDesktop" class="hidden sm:flex items-center gap-2"></div>
      <div id="authBarMobile"  class="flex sm:hidden items-center justify-end gap-2"></div>
    </div>

    <!-- Toggles de Acessibilidade / Ajuda -->
    <div class="bg-white/80 border-t">
      <div class="max-w-6xl mx-auto px-4 py-2 flex flex-wrap gap-2 items-center">
        <button id="toggleGrandma" class="btn btn-ghost text-xs">üîé Letras grandes / Modo vov√≥</button>
        <button id="toggleContrast" class="btn btn-ghost text-xs">‚¨õ Alto contraste</button>
        <button id="toggleMotion" class="btn btn-ghost text-xs">üåÄ Reduzir anima√ß√µes</button>
        <button id="btnGuidedRead" class="btn btn-ghost text-xs">üîä Ler esta tela</button>
        <div class="ml-auto flex gap-2">
          <button id="btnHelpTop" class="btn btn-primary btn-pill text-xs">‚ùì Preciso de ajuda</button>
        </div>
      </div>
    </div>
  </header>

  <!-- CTA flutuante (mobile) -->
  <button id="floatingJoinBtn" class="sm:hidden fixed top-3 right-3 btn btn-primary btn-pill text-sm">
    Participar
  </button>

  <!-- MODAL DE LOGIN -->
  <div id="authModal" class="hidden fixed inset-0 z-40">
    <div class="absolute inset-0 bg-black/40"></div>
    <div class="relative z-10 max-w-sm mx-auto mt-20 p-4 card">
      <h3 class="font-semibold mb-2">Entrar</h3>
      <p class="text-xs text-gray-700 mb-2">PIN da fam√≠lia (pergunte no grupo üí¨).
        <button id="openPinHelp" class="text-blue-700 underline ml-1">N√£o sabe o PIN?</button>
      </p>
      <div class="grid gap-2">
        <input id="nameInputModal" class="input" placeholder="Seu nome" />
        <input id="pinInputModal" class="input" placeholder="PIN" />
        <div class="flex gap-2 justify-end">
          <button id="closeLogin" class="btn btn-ghost">Cancelar</button>
          <button id="doLogin" class="btn btn-primary">Entrar</button>
        </div>
        <p class="text-xs text-gray-600">Dica: o PIN n√£o diferencia mai√∫sculas/min√∫sculas.</p>
      </div>
    </div>
  </div>

  <!-- MODAL AJUDA PIN -->
  <div id="pinHelpModal" class="hidden fixed inset-0 z-40">
    <div class="absolute inset-0 bg-black/40"></div>
    <div class="relative z-10 max-w-sm mx-auto mt-24 p-4 card">
      <h3 class="font-semibold mb-2">Como conseguir o PIN?</h3>
      <p class="text-sm text-gray-700">O PIN est√° com a fam√≠lia. Pe√ßa no grupo do WhatsApp e volte aqui para entrar. üíô</p>
      <div class="text-right mt-3">
        <button id="closePinHelp" class="btn btn-primary">Entendi</button>
      </div>
    </div>
  </div>

  <!-- MODAL AJUDA (telefone/whatsapp) -->
  <div id="helpModal" class="hidden fixed inset-0 z-50">
    <div class="absolute inset-0 bg-black/40"></div>
    <div class="relative z-10 max-w-sm mx-auto mt-24 p-4 card">
      <h3 class="font-semibold mb-2">Precisa de ajuda?</h3>
      <p class="text-sm text-gray-700 mb-3">Fale com o anfitri√£o pelo WhatsApp ou liga√ß√£o:</p>
      <div class="grid gap-2">
        <a id="helpWhats" class="btn btn-primary text-center" href="#" target="_blank">Abrir WhatsApp</a>
        <a id="helpTel" class="btn btn-ghost text-center" href="#">Ligar</a>
      </div>
      <div class="text-right mt-3">
        <button id="closeHelp" class="btn btn-ghost">Fechar</button>
      </div>
    </div>
  </div>

  <!-- MODAL QR CODES -->
  <div id="qrModal" class="hidden fixed inset-0 z-40">
    <div class="absolute inset-0 bg-black/40"></div>
    <div class="relative z-10 max-w-md mx-auto mt-20 p-4 card text-center">
      <h3 class="font-semibold mb-2">QR Codes</h3>
      <div class="grid sm:grid-cols-2 gap-4">
        <div>
          <div class="text-sm mb-1">Site do evento</div>
          <img id="qrSite" class="mx-auto" alt="QR do site">
        </div>
        <div>
          <div class="text-sm mb-1">Como chegar (Maps)</div>
          <img id="qrMaps" class="mx-auto" alt="QR do Maps">
        </div>
      </div>
      <div class="text-right mt-3">
        <button id="closeQR" class="btn btn-primary">Fechar</button>
      </div>
    </div>
  </div>

  <!-- TOAST (undo) -->
  <div id="toast" class="px-4">
    <div class="max-w-6xl mx-auto">
      <div class="card px-4 py-3 flex items-center justify-between gap-3">
        <div id="toastMsg" class="text-sm">Feito.</div>
        <div class="flex gap-2">
          <button id="toastUndo" class="btn btn-ghost">Desfazer</button>
          <button id="toastClose" class="btn btn-primary">Ok</button>
        </div>
      </div>
    </div>
  </div>

  <!-- COMO FUNCIONA -->
  <section class="max-w-6xl mx-auto px-4 mt-4">
    <div class="card p-4">
      <div class="flex items-start justify-between gap-2">
        <div>
          <h3 class="font-semibold mb-1">Como funciona</h3>
          <ol class="list-decimal ml-5 text-sm text-gray-700 space-y-1">
            <li>Toque em <strong>Participar</strong>.</li>
            <li>Digite seu <strong>nome</strong> e o <strong>PIN</strong> da fam√≠lia.</li>
            <li>Escolha um <strong>presente</strong> ou toque em <strong>Adicionar item</strong>.</li>
          </ol>
        </div>
        <div class="flex flex-col gap-2">
          <button id="btnRepeatVoice" class="btn btn-ghost text-sm">üîä Repetir</button>
          <button id="btnShowQR" class="btn btn-ghost text-sm">üì± Mostrar QR</button>
        </div>
      </div>
    </div>
  </section>

  <!-- HERO -->
  <section class="max-w-6xl mx-auto px-4 mt-4">
    <div class="grid md:grid-cols-3 gap-4">
      <div class="md:col-span-2 card p-4" id="heroCard">
        <div class="flex items-start justify-between gap-3">
          <div>
            <h2 class="text-xl font-bold">Churrasco comunit√°rio</h2>
            <p class="text-sm text-gray-700">Cada um leva um pouquinho e todo mundo curte juntinho üíô</p>
          </div>
          <div class="text-right">
            <div class="text-xs text-gray-600">Contagem regressiva</div>
            <div id="countdown" class="text-xl font-bold">--d --h --m</div>
          </div>
        </div>
        <div class="mt-4">
          <div class="flex items-center justify-between text-sm mb-2">
            <span class="font-medium">Progresso dos presentes confirmados</span>
            <span id="progressText" class="text-gray-700">0 / 0</span>
          </div>
          <div class="w-full bg-gray-200 rounded-full h-3">
            <div id="progressBar" class="bg-blue-600 h-3 rounded-full" style="width:0%"></div>
          </div>
        </div>
        <div class="mt-3">
          <button id="btnArrived" class="btn btn-ghost text-sm">üéà Cheguei!</button>
        </div>
      </div>

      <div class="card p-4">
        <h3 class="font-semibold mb-2">Informa√ß√µes r√°pidas</h3>
        <ul class="text-sm space-y-2">
          <li><span class="text-xs px-2 py-1 rounded-full bg-gray-100">Local</span>
            <span id="eventLocation">R. Alagoas, 317 - Recanto Silvestre (Fazendinha) Santana de Parna√≠ba - SP, 06530-245</span>
          </li>
          <li><span class="text-xs px-2 py-1 rounded-full bg-gray-100">Hor√°rio</span> <span id="eventTime">18h</span></li>
          <li><span class="text-xs px-2 py-1 rounded-full bg-gray-100">Dress code</span> Alegre & confort√°vel üòÑ</li>
          <li><span class="text-xs px-2 py-1 rounded-full bg-gray-100">Obs.</span> <span id="eventNotes">Leve amor, fome e boas hist√≥rias!</span></li>
        </ul>

        <!-- A√ß√µes r√°pidas -->
        <div class="mt-4 grid grid-cols-2 gap-2">
          <button id="btnAddGoogle" class="btn btn-ghost text-sm">+ Google Agenda</button>
          <button id="btnAddICS" class="btn btn-ghost text-sm">+ Apple/ICS</button>
          <a id="btnMaps" target="_blank" class="btn btn-ghost text-sm text-center" href="#">Abrir no Maps</a>
          <button id="btnShare" class="btn btn-ghost text-sm">Compartilhar</button>
        </div>
      </div>
    </div>
  </section>

  <!-- A√á√ïES -->
  <section class="max-w-6xl mx-auto px-4 mt-6 grid md:grid-cols-3 gap-4">
    <!-- Quem leva o qu√™ -->
    <div id="itemsCard" class="md:col-span-2 card p-4 relative">
      <div class="flex items-center justify-between mb-2">
        <h2 class="text-lg font-bold">Quem leva o qu√™</h2>
        <span id="itemsCountBadge" class="text-xs text-gray-700"></span>
      </div>

      <!-- Controles avan√ßados (ocultos no modo vov√≥) -->
      <div id="advancedItemsControls" class="grid gap-2 mb-3 hide-in-grandma">
        <input id="searchItems" class="input" placeholder="Buscar item ou nome de quem leva..." />
        <div class="flex flex-wrap gap-2">
          <button class="chip" data-filter="Todos" aria-pressed="true">Todos</button>
          <button class="chip" data-filter="Carnes">Carnes</button>
          <button class="chip" data-filter="Bebidas">Bebidas</button>
          <button class="chip" data-filter="Acompanhamentos">Acompanhamentos</button>
          <button class="chip" data-filter="Utens√≠lios">Utens√≠lios</button>
          <button class="chip" data-filter="Outros">Outros</button>
          <div class="ml-auto flex items-center gap-2">
            <label class="text-xs text-gray-700">Ordenar:</label>
            <select id="itemsSort" class="input w-40">
              <option value="recent">Mais recentes</option>
              <option value="owner">Quem leva</option>
              <option value="name">Nome do item</option>
            </select>
          </div>
        </div>
        <div id="itemsCounters" class="text-xs text-gray-700"></div>
        <div class="flex justify-center">
          <button id="toggleItemsHeightTop" class="text-xs text-blue-700 hover:underline hidden">ver tudo</button>
        </div>
      </div>

      <!-- Form -->
      <div id="addItemCard" class="hidden">
        <form id="addItemForm" class="grid sm:grid-cols-6 gap-2">
          <div class="sm:col-span-2 relative">
            <input id="itemName" class="input" placeholder="Ex.: Picanha" autocomplete="off" required />
            <!-- Sugest√µes -->
            <div id="itemSuggest" class="absolute z-20 left-0 right-0 mt-1 bg-white border rounded-lg shadow hidden"></div>
          </div>
          <input id="itemQty" class="input" placeholder="Qtd (ex.: 3)" type="number" min="0" step="0.1" />
          <div class="sm:col-span-1">
            <input id="itemUnit" class="input" placeholder="Unid" />
            <div class="mt-1 flex gap-1">
              <button type="button" class="chip text-xs" data-unit="kg">kg</button>
              <button type="button" class="chip text-xs" data-unit="un">un</button>
              <button type="button" class="chip text-xs" data-unit="L">L</button>
            </div>
          </div>
          <select id="itemCategory" class="input">
            <option value="Carnes">Carnes</option>
            <option value="Bebidas">Bebidas</option>
            <option value="Acompanhamentos">Acompanhamentos</option>
            <option value="Utens√≠lios">Utens√≠lios</option>
            <option value="Outros" selected>Outros</option>
          </select>
          <input id="itemNotes" class="input sm:col-span-6" placeholder="Observa√ß√µes (opcional) ‚Äî Ex.: 'trago 1,5 kg ‚Ä¢ 12 un'" />
          <button class="btn btn-primary sm:col-span-1" type="submit">Adicionar</button>
        </form>
        <hr class="my-4"/>
      </div>

      <!-- Lista com rolagem -->
      <div id="itemsList" class="grid gap-3"></div>

      <!-- Controles embaixo -->
      <div class="flex justify-center">
        <button id="toggleItemsHeight" class="mt-2 text-xs text-blue-700 hover:underline hidden">ver tudo</button>
      </div>

      <!-- Fade -->
      <div id="itemsFade" class="fade-bottom"></div>

      <!-- Export -->
      <div class="mt-3 flex flex-wrap gap-2">
        <button id="btnExportItems" class="btn btn-ghost text-sm">Baixar itens (CSV)</button>
        <button id="btnPrintPDF" class="btn btn-ghost text-sm">Exportar PDF</button>
        <button id="btnTVMode" class="btn btn-ghost text-sm">Modo TV</button>
      </div>
    </div>

    <!-- Presentes -->
    <div id="giftsCard" class="card p-4 relative">
      <div class="flex items-center justify-between mb-2">
        <h2 class="text-lg font-bold">Presentes da Tia Am√©lia</h2>
        <span class="text-xs text-gray-700">Clique em ‚Äúvou levar‚Äù</span>
      </div>

      <!-- Abas + ver todos top -->
      <div class="flex items-center gap-2 mb-2">
        <button id="tabAvail" class="tab" aria-selected="true">Dispon√≠veis</button>
        <button id="tabResvd" class="tab" aria-selected="false">Reservados</button>
        <div class="ml-auto">
          <button id="toggleGiftsHeightTop" class="text-xs text-blue-700 hover:underline hidden">ver todos</button>
        </div>
      </div>

      <div id="giftsList" class="grid gap-2 mt-2" style="grid-template-columns:repeat(2,minmax(0,1fr))"></div>

      <div class="flex justify-center">
        <button id="toggleGiftsHeight" class="mt-2 text-xs text-blue-700 hover:underline hidden">ver todos</button>
      </div>

      <div id="giftsFade" class="fade-bottom"></div>

      <div class="mt-3 flex flex-wrap gap-2">
        <button id="btnExportGifts" class="btn btn-ghost text-sm">Baixar presentes (CSV)</button>
      </div>
    </div>
  </section>

  <!-- MEUS COMBINADOS -->
  <section class="max-w-6xl mx-auto px-4 mt-6">
    <div id="myStuff" class="card p-4 hidden">
      <h3 class="font-semibold mb-2">Meus combinados</h3>
      <div class="grid md:grid-cols-2 gap-3">
        <div>
          <div class="text-sm text-gray-700 mb-2">Itens que vou levar</div>
          <div id="myItems" class="grid gap-2"></div>
        </div>
        <div>
          <div class="text-sm text-gray-700 mb-2">Presentes reservados</div>
          <div id="myGifts" class="grid gap-2"></div>
        </div>
      </div>
    </div>
  </section>

  <!-- PAINEL DO ANFITRI√ÉO -->
  <section id="adminPanel" class="max-w-6xl mx-auto px-4 mt-6 hidden">
    <div class="grid lg:grid-cols-3 gap-4">
      <div class="card p-4">
        <h3 class="font-semibold mb-2">Configura√ß√µes do evento</h3>
        <div class="grid gap-2">
          <label class="text-sm">Local</label>
          <input id="cfgLocation" class="input" />
          <label class="text-sm">Observa√ß√µes</label>
          <input id="cfgNotes" class="input" />
          <label class="text-sm">Colunas da lista de presentes</label>
          <select id="cfgCols" class="input">
            <option value="1">1 coluna</option>
            <option value="2" selected>2 colunas</option>
            <option value="3">3 colunas</option>
          </select>
          <label class="text-sm">Travar edi√ß√µes (horas antes)</label>
          <input id="cfgLockHrs" type="number" min="0" value="0" class="input w-32" />
          <button id="saveCfg" class="btn btn-primary mt-2">Salvar</button>
        </div>
      </div>

      <div class="card p-4">
        <h3 class="font-semibold mb-2">Notas fixadas</h3>
        <div class="grid gap-2">
          <label class="text-sm">Mensagem</label>
          <input id="pinNoteText" class="input" placeholder="Recado r√°pido p/ todos" />
          <label class="text-sm">Validade (opcional ‚Äî ISO ou vazio)</label>
          <input id="pinNoteUntil" class="input" placeholder="2025-08-23T23:59:00-03:00" />
          <button id="savePinnedNote" class="btn btn-primary mt-2">Fixar / Atualizar</button>
          <button id="clearPinnedNote" class="btn btn-ghost">Remover nota</button>
        </div>
      </div>

      <div class="card p-4">
        <h3 class="font-semibold mb-2">Presentes sugeridos</h3>
        <div class="grid grid-cols-[1fr_auto] gap-2">
          <input id="giftTitle" class="input" placeholder="Ex.: Toalha de rosto" />
          <input id="giftQty" class="input w-20" type="number" min="1" value="1" />
          <button id="addGift" class="btn btn-primary col-span-2">Adicionar presente</button>
        </div>
        <hr class="my-3"/>
        <div id="adminGiftsList" class="grid gap-2"></div>
      </div>
    </div>
  </section>

  <!-- NOTA FIXADA (exibe se houver) -->
  <section id="pinnedNoteWrap" class="max-w-6xl mx-auto px-4 mt-6 hidden">
    <div class="card p-4 bg-yellow-50">
      <div class="flex items-start justify-between gap-3">
        <div class="text-sm" id="pinnedNoteText"></div>
        <button id="closePinnedNote" class="btn btn-ghost text-xs hide-in-grandma">Fechar</button>
      </div>
    </div>
  </section>

  <footer class="max-w-6xl mx-auto px-4 py-10 text-center text-xs text-gray-600">
    <p class="mb-2">Aviso: √© um site de fam√≠lia; o PIN n√£o √© seguran√ßa forte. N√£o compartilhe fora do grupo.</p>
    <div class="flex items-center justify-center gap-2 mb-2">
      <button id="btnHelpBottom" class="btn btn-primary btn-pill text-xs">‚ùì Preciso de ajuda</button>
    </div>
    Feito com üíô por Caio ‚Äî hospedado no GitHub Pages
  </footer>

  <!-- APP -->
  <script type="module">
    // ===== Config do Evento (LOCAL ‚Äî PIN n√£o √© lido/salvo no Firestore) =====
    const EVENT = {
      id: 'tia-amelia-89',
      dateISO: '2025-08-23T18:00:00-03:00',
      location: 'R. Alagoas, 317 - Recanto Silvestre (Fazendinha) Santana de Parna√≠ba - SP, 06530-245',
      notes: 'Leve amor, fome e boas hist√≥rias!',
      timeText: '18h',
      familyPIN: 'AMELIA89',   // troque aqui se precisar
      adminPIN: 'HOST2025',    // troque aqui se precisar
      giftsCols: 2,
      lockHoursBefore: 0,      // 0 = nunca trava; admin ignora trava
      pinnedNote: { text:'', untilISO:'' }
    };

    // Contatos (ajuda)
    const ADMIN_PHONE = '+5511967519227'; // <- troque para o n√∫mero real
    const ADMIN_WHATSAPP = '+5511967519227'; // <- troque para o WhatsApp real

    // ===== Firebase =====
    const firebaseConfig = {
      apiKey: "AIzaSyBduTvLuvV1lrCn7_w12PF0KZ7S6sLMUnQ",
      authDomain: "niver-tia-amelia.firebaseapp.com",
      projectId: "niver-tia-amelia",
      storageBucket: "niver-tia-amelia.firebasestorage.app",
      messagingSenderId: "468653303944",
      appId: "1:468653303944:web:e64829e04eb3351b5f973d",
      measurementId: "G-F0K72Z00XB"
    };

    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.4/firebase-app.js";
    import { getAuth, signInAnonymously, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/10.12.4/firebase-auth.js";
    import {
      getFirestore, collection, doc, addDoc, setDoc, getDoc, getDocs,
      onSnapshot, serverTimestamp, query, orderBy, updateDoc, enableIndexedDbPersistence
    } from "https://www.gstatic.com/firebasejs/10.12.4/firebase-firestore.js";

    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);
    enableIndexedDbPersistence(db).catch(()=>{ /* offline cache best-effort */ });

    // ===== DOM =====
    const authBarDesktop = document.getElementById('authBarDesktop');
    const authBarMobile  = document.getElementById('authBarMobile');
    const floatingJoinBtn= document.getElementById('floatingJoinBtn');

    const authModal       = document.getElementById('authModal');
    const closeLoginBtn   = document.getElementById('closeLogin');
    const doLoginBtn      = document.getElementById('doLogin');
    const nameModal       = document.getElementById('nameInputModal');
    const pinModal        = document.getElementById('pinInputModal');
    const pinHelpModal    = document.getElementById('pinHelpModal');
    const openPinHelp     = document.getElementById('openPinHelp');
    const closePinHelp    = document.getElementById('closePinHelp');

    const helpModal = document.getElementById('helpModal');
    const helpWhats = document.getElementById('helpWhats');
    const helpTel = document.getElementById('helpTel');
    const closeHelp = document.getElementById('closeHelp');

    const qrModal = document.getElementById('qrModal');
    const qrSite = document.getElementById('qrSite');
    const qrMaps = document.getElementById('qrMaps');
    const closeQR = document.getElementById('closeQR');

    const eventDateText = document.getElementById('eventDateText');
    const eventLocation = document.getElementById('eventLocation');
    const eventTime = document.getElementById('eventTime');
    const eventNotes = document.getElementById('eventNotes');

    const btnArrived = document.getElementById('btnArrived');
    const btnRepeatVoice = document.getElementById('btnRepeatVoice');
    const btnShowQR = document.getElementById('btnShowQR');

    const progressText = document.getElementById('progressText');
    const progressBar = document.getElementById('progressBar');
    const countdownEl = document.getElementById('countdown');

    const addItemCard = document.getElementById('addItemCard');
    const addItemForm = document.getElementById('addItemForm');

    const itemsCard   = document.getElementById('itemsCard');
    const itemsList   = document.getElementById('itemsList');
    const itemsFade   = document.getElementById('itemsFade');
    const toggleItemsBtn = document.getElementById('toggleItemsHeight');
    const toggleItemsBtnTop = document.getElementById('toggleItemsHeightTop');
    const itemsCountBadge = document.getElementById('itemsCountBadge');
    const itemsCounters = document.getElementById('itemsCounters');
    const searchItems = document.getElementById('searchItems');
    const itemsSort = document.getElementById('itemsSort');

    const itemSuggest = document.getElementById('itemSuggest');

    const giftsCard        = document.getElementById('giftsCard');
    const giftsList        = document.getElementById('giftsList');
    const toggleGiftsBtn   = document.getElementById('toggleGiftsHeight');
    const toggleGiftsBtnTop= document.getElementById('toggleGiftsHeightTop');
    const giftsFade        = document.getElementById('giftsFade');
    const tabAvail         = document.getElementById('tabAvail');
    const tabResvd         = document.getElementById('tabResvd');

    const adminPanel  = document.getElementById('adminPanel');
    const cfgLocation = document.getElementById('cfgLocation');
    const cfgNotes    = document.getElementById('cfgNotes');
    const cfgCols     = document.getElementById('cfgCols');
    const cfgLockHrs  = document.getElementById('cfgLockHrs');
    const saveCfg     = document.getElementById('saveCfg');

    const pinNoteText = document.getElementById('pinNoteText');
    const pinNoteUntil= document.getElementById('pinNoteUntil');
    const savePinnedNote = document.getElementById('savePinnedNote');
    const clearPinnedNote = document.getElementById('clearPinnedNote');

    const pinnedNoteWrap = document.getElementById('pinnedNoteWrap');
    const pinnedNoteText = document.getElementById('pinnedNoteText');
    const closePinnedNote = document.getElementById('closePinnedNote');

    const giftTitle   = document.getElementById('giftTitle');
    const giftQty     = document.getElementById('giftQty');
    const addGift     = document.getElementById('addGift');
    const adminGiftsList = document.getElementById('adminGiftsList');

    const btnAddGoogle = document.getElementById('btnAddGoogle');
    const btnAddICS    = document.getElementById('btnAddICS');
    const btnMaps      = document.getElementById('btnMaps');
    const btnShare     = document.getElementById('btnShare');

    const btnExportItems = document.getElementById('btnExportItems');
    const btnExportGifts = document.getElementById('btnExportGifts');
    const btnPrintPDF    = document.getElementById('btnPrintPDF');
    const btnTVMode      = document.getElementById('btnTVMode');

    const btnHelpTop = document.getElementById('btnHelpTop');
    const btnHelpBottom = document.getElementById('btnHelpBottom');

    const toggleGrandma = document.getElementById('toggleGrandma');
    const toggleContrast = document.getElementById('toggleContrast');
    const toggleMotion = document.getElementById('toggleMotion');
    const btnGuidedRead = document.getElementById('btnGuidedRead');

    const myStuff = document.getElementById('myStuff');
    const myItems = document.getElementById('myItems');
    const myGifts = document.getElementById('myGifts');

    const toast = document.getElementById('toast');
    const toastMsg = document.getElementById('toastMsg');
    const toastUndo = document.getElementById('toastUndo');
    const toastClose = document.getElementById('toastClose');

    // ===== State =====
    let currentUser = null;
    let profileName = localStorage.getItem('profileName') || '';
    let pinOK   = localStorage.getItem('pinOK') === 'true';
    let isAdmin = localStorage.getItem('isAdmin') === 'true';

    let itemsExpanded = false;
    let giftsExpanded = false;
    let filterCategory = 'Todos';
    let giftsTab = 'available'; // 'available' | 'reserved'
    let loadingItems = true;
    let loadingGifts = true;

    let cacheItems = [];
    let cacheGifts = [];

    let undoTimer = null;
    let undoGiftDoc = null;

    let ttsEnabled = false; // leitura em voz alta (modo vov√≥ liga)
    const SPEAK_RATE = 1.0;

    // Paths
    const eventDocRef = doc(db,'events',EVENT.id);
    const itemsCol = collection(db,'events',EVENT.id,'bringItems');
    const giftsCol = collection(db,'events',EVENT.id,'gifts');

    // ===== Helpers =====
    function escapeHtml(s){ return (s||'').replace(/[&<>\"']/g, m=>({"&":"&amp;","<":"&lt;",">":"&gt;","\"":"&quot;","'":"&#39;"}[m])); }
    const norm = s => (s||'').trim().toUpperCase();

    function speak(text){
      try{
        if(!ttsEnabled) return;
        const u = new SpeechSynthesisUtterance(text);
        u.rate = SPEAK_RATE;
        window.speechSynthesis.cancel();
        window.speechSynthesis.speak(u);
      }catch(e){}
    }

    function setGiftCols(n){
      giftsList.style.gridTemplateColumns = `repeat(${n}, minmax(0,1fr))`;
      giftsList.dataset.cols = String(n);
    }

    function tickCountdown(){
      const now = new Date();
      const target = new Date(EVENT.dateISO);
      const diff = Math.max(0, target - now);
      const d = Math.floor(diff / (1000*60*60*24));
      const h = Math.floor((diff / (1000*60*60)) % 24);
      const m = Math.floor((diff / (1000*60)) % 60);
      countdownEl.textContent = `${d}d ${h}h ${m}m`;
    }
    setInterval(tickCountdown, 20000);

    function updateEventHeader(){
      eventDateText.textContent = new Date(EVENT.dateISO).toLocaleString('pt-BR',{weekday:'long',day:'2-digit',month:'long',hour:'2-digit',minute:'2-digit'});
      eventLocation.textContent = EVENT.location;
      eventTime.textContent = EVENT.timeText;
      eventNotes.textContent = EVENT.notes;
      setGiftCols(EVENT.giftsCols || 2);
      tickCountdown();

      // Maps + Calend√°rio + Share
      const mapsQ = encodeURIComponent(EVENT.location);
      btnMaps.href = `https://www.google.com/maps?q=${mapsQ}`;
      btnAddGoogle.onclick = () => {
        const dates = toGoogleDates(EVENT.dateISO, 3);
        const text = encodeURIComponent('89 anos da Tia Am√©lia üéâ');
        const details = encodeURIComponent('Churrasco comunit√°rio ‚Äî leve amor, fome e boas hist√≥rias!');
        const location = encodeURIComponent(EVENT.location);
        const url = `https://www.google.com/calendar/render?action=TEMPLATE&text=${text}&dates=${dates}&details=${details}&location=${location}`;
        window.open(url, '_blank');
      };
      btnAddICS.onclick = () => downloadICS();

      btnShare.onclick = async () => {
        const shareData = {
          title: '89 anos da Tia Am√©lia üéâ',
          text: 'Vem pro churrasco comunit√°rio! Confirma seu presente e o que vai levar üíô',
          url: window.location.href
        };
        if (navigator.share){
          try{ await navigator.share(shareData); }catch(e){}
        }else{
          const wurl = `https://wa.me/?text=${encodeURIComponent(shareData.text + ' ' + shareData.url)}`;
          window.open(wurl,'_blank');
        }
      };
    }
    updateEventHeader();

    function toGoogleDates(startISO, hours=3){
      const start = new Date(startISO);
      const end = new Date(start.getTime() + hours*60*60*1000);
      const fmt = (d)=> d.toISOString().replace(/[-:]/g,'').split('.')[0]+'Z';
      return `${fmt(start)}/${fmt(end)}`;
    }

    function downloadICS(){
      const start = new Date(EVENT.dateISO);
      const end = new Date(start.getTime() + 3*60*60*1000);
      function icsDate(d){
        const pad = n=>String(n).padStart(2,'0');
        const yyyy=d.getUTCFullYear(), mm=pad(d.getUTCMonth()+1), dd=pad(d.getUTCDate());
        const hh=pad(d.getUTCHours()), mi=pad(d.getUTCMinutes()), ss=pad(d.getUTCSeconds());
        return `${yyyy}${mm}${dd}T${hh}${mi}${ss}Z`;
      }
      const ics =
`BEGIN:VCALENDAR
VERSION:2.0
PRODID:-//Familia Amelia//Churrasco//PT-BR
BEGIN:VEVENT
UID:${Date.now()}@tia-amelia
DTSTAMP:${icsDate(new Date())}
DTSTART:${icsDate(start)}
DTEND:${icsDate(end)}
SUMMARY:89 anos da Tia Am√©lia üéâ
DESCRIPTION:Churrasco comunit√°rio ‚Äî leve amor, fome e boas hist√≥rias!
LOCATION:${EVENT.location.replace(/\n/g,' ')}
END:VEVENT
END:VCALENDAR`;
      const blob = new Blob([ics],{type:'text/calendar'});
      const a = document.createElement('a');
      a.href = URL.createObjectURL(blob);
      a.download = 'tia-amelia-89.ics';
      a.click();
      setTimeout(()=>URL.revokeObjectURL(a.href), 2000);
    }

    // ===== Acessibilidade / Ajuda / QR =====
    restoreToggles();
    document.getElementById('btnShowQR').onclick = ()=>{
      const site = encodeURIComponent(window.location.href);
      const maps = encodeURIComponent(`https://www.google.com/maps?q=${encodeURIComponent(EVENT.location)}`);
      qrSite.src = `https://api.qrserver.com/v1/create-qr-code/?size=260x260&data=${site}`;
      qrMaps.src = `https://api.qrserver.com/v1/create-qr-code/?size=260x260&data=${maps}`;
      qrModal.classList.remove('hidden');
    };
    closeQR.onclick = ()=> qrModal.classList.add('hidden');

    function toggleClassOnRoot(cls){
      document.body.classList.toggle(cls);
      localStorage.setItem('pref_'+cls, document.body.classList.contains(cls) ? '1':'0');
      // Modo Vov√≥ expande listas e liga TTS
      if(cls==='grandma'){
        const on = document.body.classList.contains('grandma');
        ttsEnabled = on || localStorage.getItem('pref_tts')==='1';
        if(on){ itemsExpanded = true; giftsExpanded = true; applyItemsScrollCap(); applyGiftsScrollCap(); }
      }
    }
    function restoreToggles(){
      ['grandma','high-contrast','reduce-motion'].forEach(k=>{
        if(localStorage.getItem('pref_'+k)==='1') document.body.classList.add(k);
      });
      ttsEnabled = (localStorage.getItem('pref_tts')==='1') || document.body.classList.contains('grandma');
    }

    toggleGrandma.onclick = ()=> toggleClassOnRoot('grandma');
    toggleContrast.onclick = ()=> toggleClassOnRoot('high-contrast');
    toggleMotion.onclick = ()=> toggleClassOnRoot('reduce-motion');

    const HELP_MSG = encodeURIComponent('Oi! N√£o consegui entrar no site do churrasco. Pode me ajudar?');
    function openHelp(){
      helpWhats.href = `https://wa.me/${ADMIN_WHATSAPP.replace(/\D/g,'')}?text=${HELP_MSG}`;
      helpTel.href = `tel:${ADMIN_PHONE.replace(/\D/g,'')}`;
      helpModal.classList.remove('hidden');
    }
    btnHelpTop.onclick = openHelp;
    btnHelpBottom.onclick = openHelp;
    closeHelp.onclick = ()=> helpModal.classList.add('hidden');

    btnRepeatVoice.onclick = ()=> speak('Passo a passo. Um: toque em Participar. Dois: digite seu nome e o PIN da fam√≠lia. Tr√™s: escolha um presente, ou toque em Adicionar item.');
    btnArrived.onclick = ()=>{
      confetti(); speak('Bem vinda, bem vindo! Boa festa!');
    };

    btnGuidedRead.onclick = guidedRead;

    // ===== Auth UI (desktop + mobile) =====
    function renderAuthBars(){
      const bars = [authBarDesktop, authBarMobile];
      bars.forEach(b => b.innerHTML = '');

      const renderLogged = (targetEl) => {
        const wrap = document.createElement('div');
        wrap.className = 'flex items-center gap-2';
        wrap.innerHTML = `
          <span class="text-sm">Ol√°, <strong>${escapeHtml(profileName)}</strong></span>
          <button data-admin class="btn btn-ghost text-xs"> ${isAdmin ? 'Sair do modo anfitri√£o' : 'Entrar como anfitri√£o'} </button>
          <button data-logout class="btn btn-ghost text-xs">Sair</button>
        `;
        targetEl.appendChild(wrap);

        wrap.querySelector('[data-logout]').onclick = async ()=>{
          await signOut(auth);
          localStorage.clear();
          profileName=''; pinOK=false; isAdmin=false;
          renderAuthBars(); rerenderLists(); renderAdminPanel(); renderMyStuff();
        };
        wrap.querySelector('[data-admin]').onclick = ()=>{
          if(isAdmin){ isAdmin=false; localStorage.removeItem('isAdmin'); }
          else{
            const p = prompt('PIN do anfitri√£o:') || '';
            if(norm(p) === norm(EVENT.adminPIN)){ isAdmin=true; localStorage.setItem('isAdmin','true'); }
            else { alert('PIN incorreto'); return; }
          }
          renderAdminPanel(); rerenderLists(); renderAuthBars();
        };
      };

      const renderAnon = (targetEl) => {
        if (targetEl === authBarDesktop){
          const name = document.createElement('input');
          name.className = 'input w-40'; name.placeholder = 'Seu nome'; name.value = profileName;

          const pin = document.createElement('input');
          pin.className = 'input w-28'; pin.placeholder = 'PIN';

          const btn = document.createElement('button');
          btn.className = 'btn btn-primary text-sm'; btn.textContent = 'Participar';
          btn.onclick = async ()=>{
            const n = (name.value||'').trim();
            const p = norm(pin.value);
            if(!n){ alert('Digite seu nome'); return; }
            if(p !== norm(EVENT.familyPIN)){ alert('PIN incorreto'); return; }
            btn.disabled = true; btn.textContent = 'Entrando...';
            try{
              await signInAnonymously(auth);
              profileName = n; pinOK = true;
              localStorage.setItem('profileName',profileName);
              localStorage.setItem('pinOK','true');
              renderAuthBars(); showToast('Voc√™ entrou!'); speak('Pronto! Voc√™ entrou.');
            }catch(e){ console.error(e); alert('Erro ao entrar'); }
            btn.disabled = false; btn.textContent = 'Participar';
          };
          targetEl.append(name,pin,btn);
        } else {
          const btn = document.createElement('button');
          btn.className = 'btn btn-primary text-sm'; btn.textContent = 'Participar';
          btn.onclick = ()=> authModal.classList.remove('hidden');
          targetEl.appendChild(btn);
        }
      };

      if(currentUser && pinOK && profileName){
        bars.forEach(renderLogged);
        addItemCard.classList.remove('hidden');
        floatingJoinBtn.classList.add('hidden');
        myStuff.classList.remove('hidden');
      }else{
        renderAnon(authBarDesktop);
        renderAnon(authBarMobile);
        addItemCard.classList.add('hidden');
        floatingJoinBtn.classList.remove('hidden');
        myStuff.classList.add('hidden');
      }
    }

    floatingJoinBtn.onclick = ()=> authModal.classList.remove('hidden');
    openPinHelp.onclick = ()=> pinHelpModal.classList.remove('hidden');
    closePinHelp.onclick = ()=> pinHelpModal.classList.add('hidden');

    closeLoginBtn?.addEventListener('click',()=> authModal.classList.add('hidden'));
    doLoginBtn?.addEventListener('click', async ()=>{
      const n = (nameModal.value||'').trim();
      const p = norm(pinModal.value);
      if(!n){ alert('Digite seu nome'); return; }
      if(p !== norm(EVENT.familyPIN)){ alert('PIN incorreto'); return; }
      doLoginBtn.disabled = true; doLoginBtn.textContent = 'Entrando...';
      try{
        await signInAnonymously(auth);
        profileName = n; pinOK = true;
        localStorage.setItem('profileName',profileName);
        localStorage.setItem('pinOK','true');
        authModal.classList.add('hidden');
        renderAuthBars(); showToast('Voc√™ entrou!'); speak('Pronto! Voc√™ entrou.');
      }catch(e){ console.error(e); alert('Erro ao entrar'); }
      doLoginBtn.disabled = false; doLoginBtn.textContent = 'Entrar';
    });

    onAuthStateChanged(auth, (u)=>{ currentUser = u; renderAuthBars(); });

    // ===== Admin Panel =====
    function renderAdminPanel(){
      adminPanel.classList.toggle('hidden', !isAdmin);
      if(!isAdmin) return;
      cfgLocation.value = EVENT.location||'';
      cfgNotes.value    = EVENT.notes||'';
      cfgCols.value     = String(EVENT.giftsCols||2);
      cfgLockHrs.value  = EVENT.lockHoursBefore||0;
      pinNoteText.value = EVENT.pinnedNote?.text || '';
      pinNoteUntil.value= EVENT.pinnedNote?.untilISO || '';
    }
    saveCfg.onclick = async ()=>{
      EVENT.location = cfgLocation.value || EVENT.location;
      EVENT.notes    = cfgNotes.value || EVENT.notes;
      EVENT.giftsCols= parseInt(cfgCols.value||'2',10);
      EVENT.lockHoursBefore = Math.max(0, parseInt(cfgLockHrs.value||'0',10));
      await setDoc(eventDocRef, {
        location: EVENT.location, notes: EVENT.notes, giftsCols: EVENT.giftsCols,
        lockHoursBefore: EVENT.lockHoursBefore
      }, { merge:true });
      updateEventHeader(); applyGiftsScrollCap(); showToast('Configura√ß√µes salvas!');
    };

    savePinnedNote.onclick = async ()=>{
      const text = pinNoteText.value||'';
      const untilISO = pinNoteUntil.value||'';
      EVENT.pinnedNote = { text, untilISO };
      await setDoc(eventDocRef, { pinnedNote: EVENT.pinnedNote }, { merge:true });
      showToast('Nota fixada!'); renderPinnedNote(EVENT.pinnedNote);
    };
    clearPinnedNote.onclick = async ()=>{
      EVENT.pinnedNote = { text:'', untilISO:'' };
      await setDoc(eventDocRef, { pinnedNote: EVENT.pinnedNote }, { merge:true });
      showToast('Nota removida!'); renderPinnedNote(EVENT.pinnedNote);
    };

    closePinnedNote.onclick = ()=> pinnedNoteWrap.classList.add('hidden');
    function renderPinnedNote(pn){
      const now = new Date();
      const until = pn?.untilISO ? new Date(pn.untilISO) : null;
      if(pn?.text && (!until || until>now)){
        pinnedNoteText.textContent = pn.text;
        pinnedNoteWrap.classList.remove('hidden');
      }else{
        pinnedNoteWrap.classList.add('hidden');
      }
    }

    // ===== Render helpers =====
    function isLocked(){
      const hrs = EVENT.lockHoursBefore||0;
      if(hrs<=0) return false;
      const now = new Date();
      const start = new Date(EVENT.dateISO);
      const diffH = (start - now) / (1000*60*60);
      return diffH <= hrs;
    }

    function itemCard(docId, d){
      const owner = d.ownerName || 'Fam√≠lia';
      const qty   = d.qty ? `${d.qty} ${d.unit||''}`.trim() : '';
      const isMine= currentUser && d.ownerUid===currentUser?.uid;
      const canRemove = (isMine || isAdmin) && !isLocked();
      return `
        <div class="card p-4">
          <div class="flex items-start gap-3">
            <div class="w-10 h-10 rounded-full bg-blue-100 flex items-center justify-center font-semibold text-blue-700">${escapeHtml(owner[0]||'?')}</div>
            <div class="flex-1">
              <div class="flex items-center justify-between">
                <div>
                  <div class="text-sm text-gray-700">${escapeHtml(owner)}</div>
                  <div class="text-lg font-semibold">${escapeHtml(d.name)}</div>
                  ${d.category?`<div class="text-xs text-gray-600 mt-1">Categoria: ${escapeHtml(d.category)}</div>`:''}
                </div>
                ${qty?`<div class="text-xs px-2 py-1 rounded-full bg-gray-100">${escapeHtml(qty)}</div>`:''}
              </div>
              ${d.notes?`<div class="text-xs text-gray-600 mt-1">${escapeHtml(d.notes)}</div>`:''}
              ${canRemove?`<div class="mt-3"><button data-del="${docId}" class="btn btn-ghost text-xs">Remover</button></div>`:''}
            </div>
          </div>
        </div>
      `;
    }

    function giftCard(docId,g){
      const reserved = !!g.reservedByName;
      const purchased = !!g.purchased;
      const who = reserved? `por <strong>${escapeHtml(g.reservedByName)}</strong>` : 'dispon√≠vel';
      const disableReserve = isLocked() && !isAdmin;
      const btnReserve = (reserved || disableReserve) ? '' : `<button data-reserve="${docId}" class="btn btn-primary text-xs">Vou levar</button>`;
      const btnFree = (reserved && isAdmin) ? `<button data-free="${docId}" class="btn btn-ghost text-xs">Liberar</button>` : '';
      const badgePurchased = purchased? `<span class="ml-2 text-green-700 text-xs">comprei ‚úÖ</span>`:'';
      return `
        <div class="card p-3 flex items-center justify-between">
          <div>
            <div class="font-medium">${escapeHtml(g.title)}</div>
            <div class="text-xs text-gray-700">${g.qty?`Qtd: ${escapeHtml(String(g.qty))}`:''}
              <span class="${reserved?'text-green-700':'text-gray-600'} ml-2">${who}${badgePurchased}</span>
            </div>
          </div>
          <div class="flex items-center gap-2">${btnReserve}${btnFree}</div>
        </div>
      `;
    }

    function adminGiftRow(id,g){
      return `
        <div class="card p-3 flex items-center justify-between">
          <div class="text-sm">
            <strong>${escapeHtml(g.title)}</strong> ${g.qty?`<span class="text-gray-600">(Qtd: ${g.qty})</span>`:''}
          </div>
          <button data-delgift="${id}" class="btn btn-ghost text-xs">Remover</button>
        </div>
      `;
    }

    // ===== Rolagem capada ‚Äî ITENS
    function calcMaxHeightForList(listEl, visibleCards = 4.5) {
      const first = listEl.children[0];
      if (!first) return 0;
      const cardH = first.getBoundingClientRect().height;
      const styles = getComputedStyle(listEl);
      const gap = parseFloat(styles.rowGap || styles.gap || 0);
      const full = Math.floor(visibleCards);
      const frac = visibleCards - full;
      const rowsGap = Math.max(0, full - 1) * gap;
      return (full * cardH) + (frac * cardH) + rowsGap;
    }
    function updateItemsFade() {
      if (!itemsList.classList.contains('overflow-auto')) { itemsFade.style.display = 'none'; return; }
      const atBottom = itemsList.scrollTop + itemsList.clientHeight >= itemsList.scrollHeight - 1;
      itemsFade.style.display = atBottom ? 'none' : 'block';
    }
    function applyItemsScrollCap() {
      const manyItems = itemsList.children.length > 4;
      const btns = [toggleItemsBtn, toggleItemsBtnTop];
      const grandma = document.body.classList.contains('grandma');

      if (itemsExpanded || !manyItems || grandma) {
        itemsList.style.maxHeight = '';
        itemsList.classList.remove('overflow-auto','pr-2');
        itemsFade.style.display = 'none';
        btns.forEach(b=>b.classList.add('hidden'));
        return;
      }
      const maxH = calcMaxHeightForList(itemsList, 4.5);
      if (maxH > 0) {
        itemsList.style.maxHeight = Math.round(maxH) + 'px';
        itemsList.classList.add('overflow-auto','pr-2');
        btns.forEach(b=>b.classList.remove('hidden'));
        updateItemsFade();
      }
    }
    function toggleItems(){
      itemsExpanded = !itemsExpanded;
      const label = itemsExpanded ? 'recolher' : 'ver tudo';
      toggleItemsBtn.textContent = label; toggleItemsBtnTop.textContent = label;
      applyItemsScrollCap();
    }
    toggleItemsBtn.addEventListener('click', toggleItems);
    toggleItemsBtnTop.addEventListener('click', toggleItems);
    itemsList.addEventListener('scroll', updateItemsFade);
    window.addEventListener('resize', () => { if (!itemsExpanded) applyItemsScrollCap(); });

    // ===== Rolagem capada ‚Äî PRESENTES
    function calcGridMaxHeight(container, visibleItems = 6.5) {
      const first = container.children[0];
      if (!first) return 0;
      const cardH = first.getBoundingClientRect().height;
      const styles = getComputedStyle(container);
      const gap = parseFloat(styles.rowGap || styles.gap || 0);
      const cols = Math.max(1, parseInt(container.dataset.cols || '2', 10));
      const fullRows = Math.floor(visibleItems / cols);
      const remainder = Math.max(0, visibleItems - (fullRows * cols));
      const fracRow = remainder > 0 ? remainder / cols : 0;
      const gaps = Math.max(0, fullRows - 1) + (fracRow > 0 ? 1 : 0);
      return (fullRows * cardH) + (fracRow * cardH) + (gaps * gap);
    }
    function updateGiftsFade() {
      if (!giftsList.classList.contains('overflow-auto')) { giftsFade.style.display = 'none'; return; }
      const atBottom = giftsList.scrollTop + giftsList.clientHeight >= giftsList.scrollHeight - 1;
      giftsFade.style.display = atBottom ? 'none' : 'block';
    }
    function applyGiftsScrollCap() {
      const visible = 6.5;
      const manyItems = giftsList.children.length > Math.floor(visible);
      const btns = [toggleGiftsBtn, toggleGiftsBtnTop];
      const grandma = document.body.classList.contains('grandma');

      if (giftsExpanded || !manyItems || grandma) {
        giftsList.style.maxHeight = '';
        giftsList.classList.remove('overflow-auto','pr-2');
        btns.forEach(b=>b.classList.add('hidden'));
        giftsFade.style.display = 'none';
        return;
      }
      const maxH = calcGridMaxHeight(giftsList, visible);
      if (maxH > 0) {
        giftsList.style.maxHeight = Math.round(maxH) + 'px';
        giftsList.classList.add('overflow-auto','pr-2');
        btns.forEach(b=>b.classList.remove('hidden'));
        updateGiftsFade();
      }
    }
    function toggleGifts(){
      giftsExpanded = !giftsExpanded;
      const label = giftsExpanded ? 'recolher' : 'ver todos';
      toggleGiftsBtn.textContent = label; toggleGiftsBtnTop.textContent = label;
      applyGiftsScrollCap();
    }
    toggleGiftsBtn.addEventListener('click', toggleGifts);
    toggleGiftsBtnTop.addEventListener('click', toggleGifts);
    giftsList.addEventListener('scroll', updateGiftsFade);
    window.addEventListener('resize', () => { if (!giftsExpanded) applyGiftsScrollCap(); });

    // ===== Filtros (itens)
    document.querySelectorAll('[data-filter]').forEach(ch=>{
      ch.addEventListener('click', ()=>{
        document.querySelectorAll('[data-filter]').forEach(x=>x.setAttribute('aria-pressed','false'));
        ch.setAttribute('aria-pressed','true');
        filterCategory = ch.dataset.filter;
        rerenderLists();
      });
    });
    searchItems.addEventListener('input', ()=> rerenderLists());
    itemsSort.addEventListener('change', ()=> rerenderLists());

    // ===== Chips unidade
    document.querySelectorAll('[data-unit]').forEach(btn=>{
      btn.addEventListener('click', ()=>{
        document.getElementById('itemUnit').value = btn.dataset.unit;
      });
    });

    // ===== Toast (undo)
    function showToast(message, onUndo, autoHideMs=5000){
      toastMsg.textContent = message;
      toast.style.display = 'block';
      const clear = ()=>{
        toast.style.display = 'none';
        toastUndo.onclick = null; toastClose.onclick = null;
        if(undoTimer){ clearTimeout(undoTimer); undoTimer=null; }
      };
      toastClose.onclick = clear;
      toastUndo.onclick = async ()=>{ clear(); if(onUndo) await onUndo(); };
      if(autoHideMs>0){ undoTimer = setTimeout(clear, autoHideMs); }
    }

    // ===== Sugest√µes & autocategoriza√ß√£o
    const SUGG = [
      {n:'Picanha',c:'Carnes'}, {n:'Lingui√ßa',c:'Carnes'}, {n:'Frango',c:'Carnes'}, {n:'Carv√£o',c:'Utens√≠lios'},
      {n:'P√£o de alho',c:'Acompanhamentos'}, {n:'Farofa',c:'Acompanhamentos'}, {n:'Vinagrete',c:'Acompanhamentos'},
      {n:'Cerveja',c:'Bebidas'}, {n:'Refrigerante',c:'Bebidas'}, {n:'Suco',c:'Bebidas'}, {n:'√Ågua',c:'Bebidas'},
      {n:'Gelo',c:'Utens√≠lios'}, {n:'Guardanapos',c:'Utens√≠lios'}, {n:'Pratos descart√°veis',c:'Utens√≠lios'}
    ];
    const CAT_KEYWORDS = {
      'Carnes':['picanha','carne','frango','lingui√ßa','maminha','alcatra','costela'],
      'Bebidas':['cerveja','refrigerante','refri','suco','√°gua','agua','vinho','drink'],
      'Acompanhamentos':['farofa','p√£o','pao','vinagrete','maionese','arroz','salada'],
      'Utens√≠lios':['carv√£o','carvao','gelo','prato','pratos','copos','talher','guardanapo','descart√°vel','panos']
    };
    const normalize = s => (s||'').normalize('NFD').replace(/[\u0300-\u036f]/g,'').toLowerCase();

    const nameInput = document.getElementById('itemName');
    nameInput.addEventListener('input', ()=>{
      const v = nameInput.value.trim();
      if(!v){ itemSuggest.classList.add('hidden'); itemSuggest.innerHTML=''; return; }
      const nv = normalize(v);
      const list = SUGG.filter(s => normalize(s.n).includes(nv)).slice(0,6);
      if(!list.length){ itemSuggest.classList.add('hidden'); itemSuggest.innerHTML=''; return; }
      itemSuggest.innerHTML = list.map(s=>`<button type="button" data-sugg="${escapeHtml(s.n)}" class="w-full text-left px-3 py-2 hover:bg-gray-50">${escapeHtml(s.n)} <span class="text-xs text-gray-500">(${s.c})</span></button>`).join('');
      itemSuggest.classList.remove('hidden');

      // autocategoriza conforme digita
      for(const [cat,words] of Object.entries(CAT_KEYWORDS)){
        if(words.some(w=> nv.includes(w))){ document.getElementById('itemCategory').value = cat; break; }
      }
    });
    itemSuggest.addEventListener('click', (e)=>{
      const b = e.target.closest('[data-sugg]'); if(!b) return;
      nameInput.value = b.getAttribute('data-sugg');
      // seta categoria sugerida
      const sug = SUGG.find(s=>s.n===nameInput.value);
      if(sug) document.getElementById('itemCategory').value = sug.c;
      itemSuggest.classList.add('hidden');
    });
    document.addEventListener('click', (e)=>{ if(!itemSuggest.contains(e.target) && e.target!==nameInput){ itemSuggest.classList.add('hidden'); } });

    // ===== Rerender Lists from cache
    function rerenderLists(){
      // --- Items: filtrar/buscar/ordenar
      const term = (searchItems?.value||'').trim().toLowerCase();
      let items = cacheItems.filter(x=>!x.data.deleted);
      if(filterCategory !== 'Todos'){
        items = items.filter(x=> (x.data.category||'Outros')===filterCategory);
      }
      if(term){
        items = items.filter(x=>{
          const d=x.data;
          return (d.name||'').toLowerCase().includes(term)
             || (d.ownerName||'').toLowerCase().includes(term)
             || (d.notes||'').toLowerCase().includes(term);
        });
      }
      if(itemsSort?.value==='owner'){
        items.sort((a,b)=> (a.data.ownerName||'').localeCompare(b.data.ownerName||''));
      }else if(itemsSort?.value==='name'){
        items.sort((a,b)=> (a.data.name||'').localeCompare(b.data.name||''));
      } // 'recent' j√° vem do snapshot desc

      const totalAll = cacheItems.filter(x=>!x.data.deleted).length;
      const distinctOwners = new Set(cacheItems.filter(x=>!x.data.deleted).map(x=>x.data.ownerUid||x.data.ownerName||'--')).size;
      itemsCounters.textContent = `Participantes: ${distinctOwners} ‚Ä¢ Total de itens: ${totalAll}`;

      itemsList.innerHTML = '';
      if(loadingItems){
        for(let i=0;i<3;i++) itemsList.insertAdjacentHTML('beforeend', `<div class="skeleton h-20"></div>`);
      }else if(items.length===0){
        itemsList.innerHTML = `<div class="text-sm text-gray-700 text-center py-6">Ainda ningu√©m combinou nada. Que tal ser o primeiro? üôå</div>`;
      }else{
        items.forEach(({id,data})=> itemsList.insertAdjacentHTML('beforeend', itemCard(id,data)));
      }

      // binds remove (debounce 1s)
      itemsList.querySelectorAll('[data-del]').forEach(btn=>{
        btn.onclick = async ()=>{
          if(isLocked() && !isAdmin){ alert('Edi√ß√µes travadas pelo anfitri√£o perto do evento.'); return; }
          if(btn.disabled) return;
          const id = btn.getAttribute('data-del');
          if(!confirm('Remover este item?')) return;
          btn.disabled = true; setTimeout(()=>btn.disabled=false, 1000);
          await setDoc(doc(db,'events',EVENT.id,'bringItems',id), { deleted:true }, { merge:true });
          speak('Item removido.');
        };
      });

      itemsCountBadge.textContent = totalAll ? `${totalAll} item(ns) combinados` : '';

      // --- Gifts por aba
      let gifts = cacheGifts.filter(x=>!x.data.deleted);
      const avail = gifts.filter(x=>!x.data.reservedByName);
      const resvd = gifts.filter(x=>!!x.data.reservedByName);
      gifts = (giftsTab==='available') ? avail : resvd;

      giftsList.innerHTML = '';
      if(loadingGifts){
        for(let i=0;i<6;i++){ giftsList.insertAdjacentHTML('beforeend', `<div class="skeleton h-16"></div>`); }
      }else if(gifts.length===0){
        giftsList.innerHTML = `<div class="text-sm text-gray-700 text-center py-6">Nada por aqui ${giftsTab==='available'?'por enquanto.':'‚Äî tudo que tinha j√° foi reservado. üíô'}</div>`;
      }else{
        gifts.forEach(({id,data})=> giftsList.insertAdjacentHTML('beforeend', giftCard(id,data)));
      }

      // binds gifts
      giftsList.querySelectorAll('[data-reserve]').forEach(btn=>{
        btn.onclick = async ()=>{
          if(!(currentUser && pinOK && profileName)){ alert('Entre com seu nome e PIN.'); return; }
          if(btn.disabled) return;
          if(isLocked() && !isAdmin){ alert('Reservas travadas pelo anfitri√£o perto do evento.'); return; }
          btn.disabled = true; setTimeout(()=>btn.disabled=false, 1000); // debounce
          const id = btn.getAttribute('data-reserve');
          const ref = doc(db,'events',EVENT.id,'gifts',id);
          await updateDoc(ref,{
            reservedByName: profileName,
            reservedByUid: currentUser.uid,
            reservedAt: serverTimestamp()
          });
          undoGiftDoc = ref;
          confetti();
          showToast('Presente reservado!', async ()=>{
            if(undoGiftDoc){
              await updateDoc(undoGiftDoc,{ reservedByName:null,reservedByUid:null,reservedAt:null, purchased:false, purchasedAt:null, purchasedByUid:null });
              undoGiftDoc = null;
              speak('Reserva desfeita.');
            }
          });
          speak('Pronto! Voc√™ reservou o presente.');
        };
      });
      giftsList.querySelectorAll('[data-free]').forEach(btn=>{
        btn.onclick = async ()=>{
          if(!isAdmin) { alert('Apenas anfitri√£o.'); return; }
          const id = btn.getAttribute('data-free');
          await updateDoc(doc(db,'events',EVENT.id,'gifts',id),{
            reservedByName: null, reservedByUid: null, reservedAt: null, purchased:false, purchasedAt:null, purchasedByUid:null
          });
        };
      });

      // admin list
      adminGiftsList.innerHTML = '';
      cacheGifts.forEach(({id,data})=>{
        if(data.deleted) return;
        if(isAdmin) adminGiftsList.insertAdjacentHTML('beforeend', adminGiftRow(id,data));
      });
      adminGiftsList.querySelectorAll('[data-delgift]').forEach(btn=>{
        btn.onclick = async ()=>{
          if(!isAdmin) return;
          const id = btn.getAttribute('data-delgift');
          if(!confirm('Remover presente da lista?')) return;
          await updateDoc(doc(db,'events',EVENT.id,'gifts',id),{ deleted:true });
        };
      });

      // progresso
      const totalGifts = cacheGifts.filter(x=>!x.data.deleted).length;
      const doneGifts  = cacheGifts.filter(x=>!x.data.deleted && x.data.reservedByName).length;
      const pct = totalGifts? Math.round((doneGifts/totalGifts)*100) : 0;
      progressText.textContent = `${doneGifts} / ${totalGifts}`;
      progressBar.style.width = pct + '%';

      // aplicar cortes
      applyItemsScrollCap();
      applyGiftsScrollCap();

      // meus combinados
      renderMyStuff();
    }

    // Abas presentes
    function setGiftsTab(tab){
      giftsTab = tab;
      tabAvail.setAttribute('aria-selected', tab==='available'?'true':'false');
      tabResvd.setAttribute('aria-selected', tab==='reserved'?'true':'false');
      rerenderLists();
    }
    tabAvail.onclick = ()=> setGiftsTab('available');
    tabResvd.onclick = ()=> setGiftsTab('reserved');

    // ===== Snapshots =====
    onSnapshot(query(itemsCol,orderBy('createdAt','desc')),(snap)=>{
      loadingItems = false;
      cacheItems = [];
      snap.forEach(ds => cacheItems.push({id: ds.id, data: ds.data()}));
      rerenderLists();
    });

    onSnapshot(giftsCol,(snap)=>{
      loadingGifts = false;
      cacheGifts = [];
      snap.forEach(ds => cacheGifts.push({id: ds.id, data: ds.data()}));
      rerenderLists();
    });

    // Config do evento (location/notes/giftsCols/lock/pinned)
    onSnapshot(eventDocRef, (ds)=>{
      if(ds.exists()){
        const cfg = ds.data();
        EVENT.location       = cfg.location ?? EVENT.location;
        EVENT.notes          = cfg.notes ?? EVENT.notes;
        EVENT.giftsCols      = cfg.giftsCols ?? EVENT.giftsCols;
        EVENT.lockHoursBefore= cfg.lockHoursBefore ?? EVENT.lockHoursBefore;
        EVENT.pinnedNote     = cfg.pinnedNote ?? EVENT.pinnedNote;
        updateEventHeader();
        renderAdminPanel();
        applyGiftsScrollCap();
        renderPinnedNote(EVENT.pinnedNote);
      }
    });

    // ===== Add item (anti-duplicados) =====
    addItemForm.addEventListener('submit', async (e)=>{
      e.preventDefault();
      if(!(currentUser && pinOK && profileName)){ alert('Entre com seu nome e PIN.'); return; }
      if(isLocked() && !isAdmin){ alert('Edi√ß√µes travadas pelo anfitri√£o perto do evento.'); return; }

      const name = document.getElementById('itemName').value.trim();
      const qty  = parseFloat(document.getElementById('itemQty').value || '');
      const unit = document.getElementById('itemUnit').value.trim();
      const notes= document.getElementById('itemNotes').value.trim();
      const category = document.getElementById('itemCategory').value || 'Outros';
      if(!name){ alert('Digite o item'); return; }

      // anti-duplicado simples por nome normalizado
      const nname = normalize(name);
      const dup = cacheItems.find(x=>!x.data.deleted && normalize(x.data.name)===nname);
      if(dup){
        const ok = confirm(`J√° existe "${dup.data.name}". Deseja somar a quantidade ao existente?`);
        if(ok){
          const newQty = (parseFloat(dup.data.qty||0) || 0) + (isNaN(qty)?0:qty);
          await updateDoc(doc(db,'events',EVENT.id,'bringItems',dup.id), { qty: isNaN(newQty)?null:newQty, notes: (dup.data.notes||'') + (notes? (' ‚Ä¢ '+notes):'') });
          showToast('Quantidade atualizada!'); e.target.reset(); return;
        }
      }

      await addDoc(itemsCol,{
        name, qty: isNaN(qty)?null:qty, unit, notes, category,
        ownerName: profileName, ownerUid: currentUser.uid,
        createdAt: serverTimestamp(), deleted:false
      });
      e.target.reset();
      confetti(); showToast('Item adicionado!'); speak('Item adicionado.');
    });

    // ===== Seed presentes (uma vez) =====
    async function seedGiftsIfEmpty(){
      const snap = await getDocs(giftsCol);
      if(snap.empty){
        const gifts = [
          { title: '6 pratos fundos', qty: 6 },
          { title: '6 pratos rasos',  qty: 6 },
          { title: 'Copos para caf√©', qty: 6 },
          { title: 'Chaleira',        qty: 1 },
          { title: 'Panela de teflon',qty: 1 },
          { title: 'Len√ßol vi√∫vo',    qty: 1 },
          { title: 'Meia d√∫zia de colheres', qty: 6 },
          { title: 'Meia d√∫zia de facas',    qty: 6 },
          { title: 'Meia d√∫zia de garfos',   qty: 6 },
          { title: 'Panos de prato',  qty: 3 },
          { title: 'Toalha de mesa pequena (quadrada)', qty: 1 }
        ];
        await Promise.all(gifts.map(g => addDoc(giftsCol, { ...g, deleted:false, createdAt: serverTimestamp() })));
      }
    }
    seedGiftsIfEmpty();

    // ===== Export CSV / PDF =====
    function toCSV(rows){
      return rows.map(r=> r.map(v=>{
        const s = (v==null?'':String(v)).replace(/"/g,'""');
        return `"${s}"`;
      }).join(',')).join('\n');
    }
    btnExportItems.onclick = ()=>{
      const rows = [['Item','Quantidade','Unid','Categoria','Observa√ß√µes','Quem leva']];
      cacheItems.filter(x=>!x.data.deleted).forEach(x=>{
        const d=x.data; rows.push([d.name||'', d.qty||'', d.unit||'', d.category||'', d.notes||'', d.ownerName||'']);
      });
      const blob = new Blob([toCSV(rows)],{type:'text/csv'});
      const a = document.createElement('a'); a.href=URL.createObjectURL(blob); a.download='itens.csv'; a.click();
      setTimeout(()=>URL.revokeObjectURL(a.href), 1500);
    };
    btnExportGifts.onclick = ()=>{
      const rows = [['Presente','Qtd','Status','Por quem','Comprei']];
      cacheGifts.filter(x=>!x.data.deleted).forEach(x=>{
        const d=x.data; rows.push([d.title||'', d.qty||'', d.reservedByName?'Reservado':'Dispon√≠vel', d.reservedByName||'', d.purchased?'Sim':'N√£o']);
      });
      const blob = new Blob([toCSV(rows)],{type:'text/csv'});
      const a = document.createElement('a'); a.href=URL.createObjectURL(blob); a.download='presentes.csv'; a.click();
      setTimeout(()=>URL.revokeObjectURL(a.href), 1500);
    };
    btnPrintPDF.onclick = ()=>{
      const w = window.open('', '_blank');
      const totalGifts = cacheGifts.filter(x=>!x.data.deleted).length;
      const doneGifts  = cacheGifts.filter(x=>!x.data.deleted && x.data.reservedByName).length;
      const html = `
      <html><head><title>Resumo ‚Äî Tia Am√©lia</title>
      <style>body{font-family:system-ui,Segoe UI,Roboto,Arial;margin:24px} h1{margin:0 0 8px} .small{color:#555}
      table{border-collapse:collapse;width:100%;margin-top:12px} td,th{border:1px solid #ccc;padding:6px;text-align:left;font-size:13px}</style>
      </head><body>
      <h1>89 anos da Tia Am√©lia üéâ</h1>
      <div class="small">${new Date(EVENT.dateISO).toLocaleString('pt-BR')} ‚Äî ${EVENT.location}</div>
      <h2>Presentes (${doneGifts}/${totalGifts})</h2>
      <table><tr><th>Presente</th><th>Qtd</th><th>Status</th><th>Por quem</th><th>Comprei</th></tr>
      ${cacheGifts.filter(x=>!x.data.deleted).map(x=>{
        const d=x.data; return `<tr><td>${d.title||''}</td><td>${d.qty||''}</td><td>${d.reservedByName?'Reservado':'Dispon√≠vel'}</td><td>${d.reservedByName||''}</td><td>${d.purchased?'‚úÖ':''}</td></tr>`;
      }).join('')}
      </table>
      <h2>Quem leva o qu√™</h2>
      <table><tr><th>Item</th><th>Qtd</th><th>Unid</th><th>Categoria</th><th>Observa√ß√µes</th><th>Quem leva</th></tr>
      ${cacheItems.filter(x=>!x.data.deleted).map(x=>{
        const d=x.data; return `<tr><td>${d.name||''}</td><td>${d.qty||''}</td><td>${d.unit||''}</td><td>${d.category||''}</td><td>${d.notes||''}</td><td>${d.ownerName||''}</td></tr>`;
      }).join('')}
      </table>
      <p class="small">QR do Maps: ${EVENT.location}</p>
      </body></html>`;
      w.document.write(html); w.document.close(); w.focus(); w.print();
    };

    // ===== Modo TV =====
    btnTVMode.onclick = ()=>{
      const url = new URL(window.location.href);
      url.searchParams.set('tv','1');
      window.location.href = url.toString();
    };
    if(new URL(window.location.href).searchParams.get('tv')==='1'){
      document.querySelector('header').style.display='none';
      document.querySelector('footer').style.display='none';
      document.getElementById('adminPanel').style.display='none';
      document.getElementById('authModal').style.display='none';
      floatingJoinBtn.style.display='none';

      const tv = document.createElement('div');
      tv.className = 'fixed inset-0 flex items-center justify-center';
      tv.style.background='white';
      tv.innerHTML = `
        <div class="max-w-4xl mx-auto p-6 text-center">
          <div class="text-3xl font-bold mb-4">89 anos da Tia Am√©lia üéâ</div>
          <div class="text-lg text-gray-700 mb-4" id="tvCountdown">Carregando...</div>
          <div class="w-full bg-gray-200 rounded-full h-4 mb-3">
            <div id="tvProgress" class="bg-blue-600 h-4 rounded-full" style="width:0%"></div>
          </div>
          <div id="tvProgressText" class="text-sm text-gray-700 mb-6">0 / 0 confirmados</div>
          <div id="tvTicker" class="text-xl font-semibold"></div>
        </div>`;
      document.body.appendChild(tv);

      function tvTick(){
        const now = new Date();
        const target = new Date(EVENT.dateISO);
        const diff = Math.max(0, target - now);
        const d = Math.floor(diff / (1000*60*60*24));
        const h = Math.floor((diff / (1000*60*60)) % 24);
        const m = Math.floor((diff / (1000*60)) % 60);
        tv.querySelector('#tvCountdown').textContent = `Faltam ${d}d ${h}h ${m}m`;
      }
      setInterval(tvTick, 20000); tvTick();

      setInterval(()=>{
        const list = cacheItems.filter(x=>!x.data.deleted);
        if(!list.length){ tv.querySelector('#tvTicker').textContent = 'Sem itens ainda üôå'; return; }
        const i = Math.floor(Math.random()*list.length);
        const d=list[i].data;
        tv.querySelector('#tvTicker').textContent = `${d.ownerName||'Fam√≠lia'} vai levar ${d.name}${d.qty?` ‚Äî ${d.qty} ${d.unit||''}`:''}`;
      }, 4000);

      function updateTVProgress(){
        const totalGifts = cacheGifts.filter(x=>!x.data.deleted).length;
        const doneGifts  = cacheGifts.filter(x=>!x.data.deleted && x.data.reservedByName).length;
        const pct = totalGifts? Math.round((doneGifts/totalGifts)*100) : 0;
        tv.querySelector('#tvProgress').style.width = pct + '%';
        tv.querySelector('#tvProgressText').textContent = `${doneGifts} / ${totalGifts} confirmados`;
      }
      const _orig = rerenderLists;
      rerenderLists = function(){ _orig(); updateTVProgress(); };
    }

    // ===== Meus combinados =====
    function renderMyStuff(){
      if(!(currentUser && pinOK && profileName)){ myStuff.classList.add('hidden'); return; }
      myStuff.classList.remove('hidden');
      myItems.innerHTML = '';
      cacheItems.filter(x=>!x.data.deleted && x.data.ownerUid===currentUser?.uid)
        .forEach(({id,data})=>{
          myItems.insertAdjacentHTML('beforeend', `
            <div class="card p-3 flex items-center justify-between">
              <div class="text-sm"><strong>${escapeHtml(data.name)}</strong> ${data.qty?`<span class="text-gray-600">(${data.qty} ${data.unit||''})</span>`:''}</div>
              <button data-del="${id}" class="btn btn-ghost text-xs">Remover</button>
            </div>`);
        });
      myItems.querySelectorAll('[data-del]').forEach(btn=>{
        btn.onclick = async ()=>{
          if(isLocked() && !isAdmin){ alert('Edi√ß√µes travadas pelo anfitri√£o.'); return; }
          const id = btn.getAttribute('data-del');
          if(!confirm('Remover este item?')) return;
          await setDoc(doc(db,'events',EVENT.id,'bringItems',id), { deleted:true }, { merge:true });
        };
      });

      myGifts.innerHTML = '';
      cacheGifts.filter(x=>!x.data.deleted && x.data.reservedByUid===currentUser?.uid)
        .forEach(({id,data})=>{
          myGifts.insertAdjacentHTML('beforeend', `
            <div class="card p-3 flex items-center justify-between">
              <div class="text-sm"><strong>${escapeHtml(data.title)}</strong> ${data.qty?`<span class="text-gray-600">(${data.qty})</span>`:''} ${data.purchased?' <span class="text-green-700">comprei ‚úÖ</span>':''}</div>
              <div class="flex gap-2">
                <button data-unreserve="${id}" class="btn btn-ghost text-xs">Desfazer reserva</button>
                <button data-bought="${id}" class="btn btn-primary text-xs">${data.purchased?'Desmarcar':'Comprei'}</button>
              </div>
            </div>`);
        });
      myGifts.querySelectorAll('[data-unreserve]').forEach(btn=>{
        btn.onclick = async ()=>{
          const id = btn.getAttribute('data-unreserve');
          await updateDoc(doc(db,'events',EVENT.id,'gifts',id),{ reservedByName:null,reservedByUid:null,reservedAt:null,purchased:false,purchasedAt:null,purchasedByUid:null });
        };
      });
      myGifts.querySelectorAll('[data-bought]').forEach(btn=>{
        btn.onclick = async ()=>{
          const id = btn.getAttribute('data-bought');
          const g = cacheGifts.find(x=>x.id===id)?.data || {};
          const newState = !g.purchased;
          await updateDoc(doc(db,'events',EVENT.id,'gifts',id),{ purchased:newState, purchasedAt: newState? serverTimestamp(): null, purchasedByUid: newState? currentUser?.uid : null });
        };
      });
    }

    // ===== Confete simples =====
    function confetti(){
      if(document.body.classList.contains('reduce-motion')) return;
      const colors = ['#f87171','#fbbf24','#34d399','#60a5fa','#a78bfa','#f472b6'];
      for(let i=0;i<24;i++){
        const div = document.createElement('div');
        div.style.position='fixed'; div.style.top='-10px'; div.style.left = (Math.random()*100)+'%';
        div.style.width='8px'; div.style.height='12px'; div.style.background=colors[(Math.random()*colors.length)|0];
        div.style.opacity='0.9'; div.style.zIndex='70'; div.style.transform=`rotate(${Math.random()*360}deg)`;
        document.body.appendChild(div);
        const endY = window.innerHeight + 20;
        const dur = 700 + Math.random()*800;
        const drift = (Math.random()*100 - 50) + 'px';
        div.animate([
          { transform: div.style.transform+' translate(0,0)', opacity:1 },
          { transform: 'translate('+drift+','+endY+'px) rotate(360deg)', opacity:0.9 }
        ], { duration: dur, easing:'ease-out' });
        setTimeout(()=> div.remove(), dur);
      }
    }

    // ===== Guided Read (destaca e l√™) =====
    async function guidedRead(){
      const steps = [
        {el: document.getElementById('heroCard'), t:'Este √© o resumo do evento. Aqui voc√™ v√™ a data e um contador.'},
        {el: document.getElementById('itemsCard'), t:'Nesta parte, combinamos quem leva o qu√™.'},
        {el: document.getElementById('giftsCard'), t:'Aqui voc√™ reserva os presentes para a Tia Am√©lia.'}
      ];
      for(const s of steps){
        try{ s.el.classList.add('guided'); }catch(e){}
        speak(s.t);
        await new Promise(r=> setTimeout(r, 2000));
        try{ s.el.classList.remove('guided'); }catch(e){}
      }
      speak('Prontinho. Qualquer d√∫vida, toque em Preciso de ajuda.');
    }

    // ===== Inicial =====
    renderAuthBars();
    renderAdminPanel();

    // Ajuda
    document.getElementById('btnHelpTop')?.addEventListener('click', openHelp);
    document.getElementById('btnHelpBottom')?.addEventListener('click', openHelp);

    // ===== Service Worker (opcional): se /sw.js existir, registra
    if('serviceWorker' in navigator){
      navigator.serviceWorker.register('/sw.js').catch(()=>{/* opcional */});
    }

    // ===== Regras Firestore (lembrete)
    // rules_version = '2';
    // service cloud.firestore {
    //   match /databases/{database}/documents {
    //     function isAuthed(){ return request.auth != null; }
    //     match /events/{eventId} {
    //       allow read: if true;
    //       allow write: if isAuthed();
    //       match /{col=**}/{docId} {
    //         allow read: if true;
    //         allow write: if isAuthed();
    //       }
    //     }
    //   }
    // }
  </script>

  <!--
    (Opcional) Para PWA completo/offline do HTML tamb√©m:
    crie um arquivo /sw.js na raiz do seu GitHub Pages com:

    const CACHE = 'tia-amelia-v1';
    const ASSETS = ['/', '/index.html'];
    self.addEventListener('install', e => {
      e.waitUntil(caches.open(CACHE).then(c => c.addAll(ASSETS)).then(()=>self.skipWaiting()));
    });
    self.addEventListener('activate', e => { e.waitUntil(self.clients.claim()); });
    self.addEventListener('fetch', e => {
      const req = e.request;
      e.respondWith(
        caches.match(req).then(cached => cached || fetch(req).then(res=>{
          const copy = res.clone();
          caches.open(CACHE).then(c=> c.put(req, copy));
          return res;
        }).catch(()=> cached))
      );
    });

    (Manifest √© opcional; para ‚ÄúAdicionar √† tela inicial‚Äù, o iOS/Android j√° permitem via menu do navegador.)
  -->
</body>
</html>
