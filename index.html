<!DOCTYPE html>
<html lang="pt-br">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>89 anos da Tia Am√©lia üéâ | Churrasco Comunit√°rio</title>
  <meta name="description" content="Organizador do churrasco comunit√°rio da Tia Am√©lia (89). Reserve presentes, cadastre o que vai levar e acompanhe o progresso em tempo real." />
  <link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='.9em' font-size='90'>üéÇ</text></svg>">
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    .card{border:1px solid #e5e7eb;border-radius:1rem;background:#fff}
    .btn{border-radius:.75rem;padding:.5rem .75rem;font-weight:600}
    .btn-primary{background:#2563eb;color:#fff}
    .btn-ghost{background:#fff;border:1px solid #e5e7eb}
    .input{width:100%;border:1px solid #e5e7eb;border-radius:.75rem;padding:.5rem .75rem}

    /* --- Rolagem capada do grid de presentes --- */
    #giftsList { scroll-behavior: smooth; }
    /* Fade suave no rodap√© (usado nos presentes; gen√©rico para reuso) */
    .fade-bottom {
      position: absolute;
      left: 1rem;           /* bate com padding .p-4 */
      right: 1rem;
      bottom: 1rem;
      height: 36px;
      pointer-events: none;
      display: none;        /* JS liga/desliga */
      background: linear-gradient(to bottom, rgba(255,255,255,0), #ffffff);
      border-bottom-left-radius: 1rem;
      border-bottom-right-radius: 1rem;
    }
    /* Scrollbar discreta (Chromium/WebKit) */
    #giftsList::-webkit-scrollbar { width: 8px; }
    #giftsList::-webkit-scrollbar-thumb { background:#d1d5db; border-radius:8px; }
  </style>
</head>
<body class="min-h-screen text-gray-800" style="background:linear-gradient(to bottom,#f0f6ff,#ffffff,#fff5f5)">
  <!-- HEADER -->
  <header class="sticky top-0 z-30 bg-white/80 backdrop-blur border-b">
    <div class="max-w-6xl mx-auto px-4 py-3 grid grid-cols-2 sm:grid-cols-[auto_1fr_auto] items-center gap-3">
      <div class="flex items-center gap-2">
        <div class="text-2xl">üéâ</div>
        <div class="leading-tight">
          <div class="text-sm sm:text-base font-bold">89 anos da Tia Am√©lia</div>
          <div id="eventDateText" class="text-xs sm:text-sm text-gray-600">‚Äì</div>
        </div>
      </div>

      <!-- espa√ßador -->
      <div class="hidden sm:block"></div>

      <!-- Barras de autentica√ß√£o -->
      <div id="authBarDesktop" class="hidden sm:flex items-center gap-2"></div>
      <div id="authBarMobile"  class="flex sm:hidden items-center justify-end gap-2"></div>
    </div>
  </header>

  <!-- MODAL DE LOGIN (mobile e fallback) -->
  <div id="authModal" class="hidden fixed inset-0 z-40">
    <div class="absolute inset-0 bg-black/40"></div>
    <div class="relative z-10 max-w-sm mx-auto mt-24 p-4 card">
      <h3 class="font-semibold mb-2">Entrar</h3>
      <div class="grid gap-2">
        <input id="nameInputModal" class="input" placeholder="Seu nome" />
        <input id="pinInputModal" class="input" placeholder="PIN" />
        <div class="flex gap-2 justify-end">
          <button id="closeLogin" class="btn btn-ghost">Cancelar</button>
          <button id="doLogin" class="btn btn-primary">Entrar</button>
        </div>
        <p class="text-xs text-gray-500">Dica: o PIN n√£o diferencia mai√∫sculas/min√∫sculas.</p>
      </div>
    </div>
  </div>

  <!-- HERO -->
  <section class="max-w-6xl mx-auto px-4 mt-6">
    <div class="grid md:grid-cols-3 gap-4">
      <div class="md:col-span-2 card p-4">
        <div class="flex items-start justify-between gap-3">
          <div>
            <h2 class="text-xl font-bold">Churrasco comunit√°rio</h2>
            <p class="text-sm text-gray-600">Cada um leva um pouquinho e todo mundo curte juntinho üíô</p>
          </div>
          <div class="text-right">
            <div class="text-xs text-gray-500">Contagem regressiva</div>
            <div id="countdown" class="text-xl font-bold">--d --h --m</div>
          </div>
        </div>
        <div class="mt-4">
          <div class="flex items-center justify-between text-sm mb-2">
            <span class="font-medium">Progresso dos presentes confirmados</span>
            <span id="progressText" class="text-gray-600">0 / 0</span>
          </div>
          <div class="w-full bg-gray-200 rounded-full h-3">
            <div id="progressBar" class="bg-blue-600 h-3 rounded-full" style="width:0%"></div>
          </div>
        </div>
      </div>

      <div class="card p-4">
        <h3 class="font-semibold mb-2">Informa√ß√µes r√°pidas</h3>
        <ul class="text-sm space-y-2">
          <li><span class="text-xs px-2 py-1 rounded-full bg-gray-100">Local</span> <span id="eventLocation">Casa da fam√≠lia</span></li>
          <li><span class="text-xs px-2 py-1 rounded-full bg-gray-100">Hor√°rio</span> <span id="eventTime">18h</span></li>
          <li><span class="text-xs px-2 py-1 rounded-full bg-gray-100">Dress code</span> Alegre & confort√°vel üòÑ</li>
          <li><span class="text-xs px-2 py-1 rounded-full bg-gray-100">Obs.</span> <span id="eventNotes">Leve amor, fome e boas hist√≥rias!</span></li>
        </ul>
      </div>
    </div>
  </section>

  <!-- A√á√ïES -->
  <section class="max-w-6xl mx-auto px-4 mt-6 grid md:grid-cols-3 gap-4">
    <!-- Quem leva o qu√™ -->
    <div class="md:col-span-2 card p-4">
      <div class="flex items-center justify-between mb-2">
        <h2 class="text-lg font-bold">Quem leva o qu√™</h2>
        <span id="itemsCountBadge" class="text-xs text-gray-500"></span>
      </div>

      <!-- Form -->
      <div id="addItemCard" class="hidden">
        <form id="addItemForm" class="grid sm:grid-cols-5 gap-2">
          <input id="itemName" class="input sm:col-span-2" placeholder="Ex.: Picanha" required />
          <input id="itemQty" class="input" placeholder="Qtd (ex.: 3)" type="number" min="0" step="0.1" />
          <input id="itemUnit" class="input" placeholder="Unid (kg, un, L)" />
          <input id="itemNotes" class="input sm:col-span-5" placeholder="Observa√ß√µes (opcional)" />
          <button class="btn btn-primary sm:col-span-1" type="submit">Adicionar</button>
        </form>
        <hr class="my-4"/>
      </div>

      <!-- Lista -->
      <div id="itemsList" class="grid gap-3"></div>
    </div>

    <!-- Presentes (com rolagem + fade + ver todos) -->
    <div id="giftsCard" class="card p-4 relative">
      <div class="flex items-center justify-between">
        <h2 class="text-lg font-bold">Presentes da Tia Am√©lia</h2>
        <span class="text-xs text-gray-500">Clique em ‚Äúvou levar‚Äù</span>
      </div>

      <div id="giftsList" class="grid gap-2 mt-3" style="grid-template-columns:repeat(2,minmax(0,1fr))"></div>

      <div class="flex justify-center">
        <button id="toggleGiftsHeight" class="mt-2 text-xs text-blue-600 hover:underline hidden">
          ver todos
        </button>
      </div>

      <div id="giftsFade" class="fade-bottom"></div>
    </div>
  </section>

  <!-- PAINEL DO ANFITRI√ÉO -->
  <section id="adminPanel" class="max-w-6xl mx-auto px-4 mt-6 hidden">
    <div class="grid lg:grid-cols-3 gap-4">
      <div class="card p-4">
        <h3 class="font-semibold mb-2">Configura√ß√µes do evento</h3>
        <div class="grid gap-2">
          <label class="text-sm">Local</label>
          <input id="cfgLocation" class="input" />
          <label class="text-sm">Observa√ß√µes</label>
          <input id="cfgNotes" class="input" />
          <label class="text-sm">Colunas da lista de presentes</label>
          <select id="cfgCols" class="input">
            <option value="1">1 coluna</option>
            <option value="2" selected>2 colunas</option>
            <option value="3">3 colunas</option>
          </select>
          <button id="saveCfg" class="btn btn-primary mt-2">Salvar</button>
        </div>
      </div>

      <div class="card p-4">
        <h3 class="font-semibold mb-2">Seguran√ßa</h3>
        <div class="grid gap-2">
          <label class="text-sm">PIN da fam√≠lia</label>
          <input id="cfgFamilyPIN" class="input" />
          <label class="text-sm">PIN do anfitri√£o</label>
          <input id="cfgAdminPIN" class="input" />
          <button id="savePins" class="btn btn-primary mt-2">Atualizar PINs</button>
          <p class="text-xs text-gray-500">Dica: simples, mas compartilhe s√≥ com a fam√≠lia.</p>
        </div>
      </div>

      <div class="card p-4">
        <h3 class="font-semibold mb-2">Presentes sugeridos</h3>
        <div class="grid grid-cols-[1fr_auto] gap-2">
          <input id="giftTitle" class="input" placeholder="Ex.: Toalha de rosto" />
          <input id="giftQty" class="input w-20" type="number" min="1" value="1" />
          <button id="addGift" class="btn btn-primary col-span-2">Adicionar presente</button>
        </div>
        <hr class="my-3"/>
        <div id="adminGiftsList" class="grid gap-2"></div>
      </div>
    </div>
  </section>

  <footer class="max-w-6xl mx-auto px-4 py-10 text-center text-xs text-gray-500">
    Feito com üíô por Caio ‚Äî hospedado no GitHub Pages
  </footer>

  <!-- APP -->
  <script type="module">
    // ===== Config do Evento (defaults; podem ser sobrescritos pela doc do Firestore)
    const EVENT = {
      id: 'tia-amelia-89',
      dateISO: '2025-08-23T18:00:00-03:00',
      location: 'Casa da fam√≠lia',
      notes: 'Leve amor, fome e boas hist√≥rias!',
      timeText: '18h',
      familyPIN: 'AMELIA89',
      adminPIN: 'HOST2025',
      giftsCols: 2
    };

    // ===== Firebase
    const firebaseConfig = {
      apiKey: "AIzaSyBduTvLuvV1lrCn7_w12PF0KZ7S6sLMUnQ",
      authDomain: "niver-tia-amelia.firebaseapp.com",
      projectId: "niver-tia-amelia",
      storageBucket: "niver-tia-amelia.firebasestorage.app",
      messagingSenderId: "468653303944",
      appId: "1:468653303944:web:e64829e04eb3351b5f973d",
      measurementId: "G-F0K72Z00XB"
    };

    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.4/firebase-app.js";
    import { getAuth, signInAnonymously, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/10.12.4/firebase-auth.js";
    import { getFirestore, collection, doc, addDoc, setDoc, getDoc, getDocs, onSnapshot, serverTimestamp, query, orderBy, updateDoc } from "https://www.gstatic.com/firebasejs/10.12.4/firebase-firestore.js";

    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);

    // ===== DOM
    const authBarDesktop = document.getElementById('authBarDesktop');
    const authBarMobile  = document.getElementById('authBarMobile');

    const authModal       = document.getElementById('authModal');
    const closeLoginBtn   = document.getElementById('closeLogin');
    const doLoginBtn      = document.getElementById('doLogin');
    const nameModal       = document.getElementById('nameInputModal');
    const pinModal        = document.getElementById('pinInputModal');

    const eventDateText = document.getElementById('eventDateText');
    const eventLocation = document.getElementById('eventLocation');
    const eventTime = document.getElementById('eventTime');
    const eventNotes = document.getElementById('eventNotes');

    const progressText = document.getElementById('progressText');
    const progressBar = document.getElementById('progressBar');
    const countdownEl = document.getElementById('countdown');

    const addItemCard = document.getElementById('addItemCard');
    const addItemForm = document.getElementById('addItemForm');
    const itemsList   = document.getElementById('itemsList');
    const itemsCountBadge = document.getElementById('itemsCountBadge');

    const giftsCard        = document.getElementById('giftsCard');
    const giftsList        = document.getElementById('giftsList');
    const toggleGiftsBtn   = document.getElementById('toggleGiftsHeight');
    const giftsFade        = document.getElementById('giftsFade');

    const adminPanel  = document.getElementById('adminPanel');
    const cfgLocation = document.getElementById('cfgLocation');
    const cfgNotes    = document.getElementById('cfgNotes');
    const cfgCols     = document.getElementById('cfgCols');
    const saveCfg     = document.getElementById('saveCfg');
    const cfgFamilyPIN= document.getElementById('cfgFamilyPIN');
    const cfgAdminPIN = document.getElementById('cfgAdminPIN');
    const savePins    = document.getElementById('savePins');
    const giftTitle   = document.getElementById('giftTitle');
    const giftQty     = document.getElementById('giftQty');
    const addGift     = document.getElementById('addGift');
    const adminGiftsList = document.getElementById('adminGiftsList');

    // ===== State
    let currentUser = null;
    let profileName = localStorage.getItem('profileName') || '';
    let pinOK   = localStorage.getItem('pinOK') === 'true';
    let isAdmin = localStorage.getItem('isAdmin') === 'true';

    // estado do ‚Äúver todos‚Äù dos presentes
    let giftsExpanded = false;

    // Caches para rerender sem precisar refazer snapshot
    let cacheItems = [];
    let cacheGifts = [];

    // Paths
    const eventDocRef = doc(db,'events',EVENT.id); // doc raiz com settings
    const itemsCol = collection(db,'events',EVENT.id,'bringItems');
    const giftsCol = collection(db,'events',EVENT.id,'gifts');

    // ===== Helpers
    function escapeHtml(s){ return (s||'').replace(/[&<>"']/g, m=>({"&":"&amp;","<":"&lt;",">":"&gt;","\"":"&quot;","'":"&#39;"}[m])); }
    const norm = s => (s||'').trim().toUpperCase();

    function setGiftCols(n){
      giftsList.style.gridTemplateColumns = `repeat(${n}, minmax(0,1fr))`;
      giftsList.dataset.cols = String(n); // guarda colunas para o c√°lculo do corte
    }

    function tickCountdown(){
      const now = new Date();
      const target = new Date(EVENT.dateISO);
      const diff = Math.max(0, target - now);
      const d = Math.floor(diff / (1000*60*60*24));
      const h = Math.floor((diff / (1000*60*60)) % 24);
      const m = Math.floor((diff / (1000*60)) % 60);
      countdownEl.textContent = `${d}d ${h}h ${m}m`;
    }
    setInterval(tickCountdown, 20000);

    function updateEventHeader(){
      eventDateText.textContent = new Date(EVENT.dateISO).toLocaleString('pt-BR',{weekday:'long',day:'2-digit',month:'long',hour:'2-digit',minute:'2-digit'});
      eventLocation.textContent = EVENT.location;
      eventTime.textContent = EVENT.timeText;
      eventNotes.textContent = EVENT.notes;
      setGiftCols(EVENT.giftsCols || 2);
      tickCountdown();
    }
    updateEventHeader();

    // ===== Auth UI (desktop + mobile)
    function renderAuthBars(){
      const bars = [authBarDesktop, authBarMobile];
      bars.forEach(b => b.innerHTML = '');

      const renderLogged = (targetEl) => {
        const wrap = document.createElement('div');
        wrap.className = 'flex items-center gap-2';
        wrap.innerHTML = `
          <span class="text-sm">Ol√°, <strong>${escapeHtml(profileName)}</strong></span>
          <button data-admin class="btn btn-ghost text-xs">${isAdmin ? 'Sair do modo anfitri√£o' : 'Entrar como anfitri√£o'}</button>
          <button data-logout class="btn btn-ghost text-xs">Sair</button>
        `;
        targetEl.appendChild(wrap);

        wrap.querySelector('[data-logout]').onclick = async ()=>{
          await signOut(auth);
          localStorage.clear();
          profileName=''; pinOK=false; isAdmin=false;
          renderAuthBars();
          rerenderLists();
          renderAdminPanel();
        };

        wrap.querySelector('[data-admin]').onclick = ()=>{
          if(isAdmin){
            isAdmin = false; localStorage.removeItem('isAdmin');
          }else{
            const p = prompt('PIN do anfitri√£o:') || '';
            if(norm(p) === norm(EVENT.adminPIN)){ isAdmin = true; localStorage.setItem('isAdmin','true'); }
            else { alert('PIN incorreto'); return; }
          }
          renderAdminPanel();
          rerenderLists();
          renderAuthBars(); // atualiza r√≥tulo nos dois lugares
        };
      };

      const renderAnon = (targetEl) => {
        // Desktop: campos + bot√£o; Mobile: bot√£o que abre modal
        if (targetEl === authBarDesktop){
          const name = document.createElement('input');
          name.className = 'input w-40';
          name.placeholder = 'Seu nome';
          name.value = profileName;

          const pin = document.createElement('input');
          pin.className = 'input w-28';
          pin.placeholder = 'PIN';

          const btn = document.createElement('button');
          btn.className = 'btn btn-primary text-sm';
          btn.textContent = 'Entrar';
          btn.onclick = async ()=>{
            const n = (name.value||'').trim();
            const p = norm(pin.value);
            if(!n){ alert('Digite seu nome'); return; }
            if(p !== norm(EVENT.familyPIN)){ alert('PIN incorreto'); return; }
            btn.disabled = true; btn.textContent = 'Entrando...';
            try{
              await signInAnonymously(auth);
              profileName = n; pinOK = true;
              localStorage.setItem('profileName',profileName);
              localStorage.setItem('pinOK','true');
              renderAuthBars(); // atualiza imediatamente
            }catch(e){ console.error(e); alert('Erro ao entrar'); }
            btn.disabled = false; btn.textContent = 'Entrar';
          };
          targetEl.append(name,pin,btn);
        } else {
          const btn = document.createElement('button');
          btn.className = 'btn btn-primary text-sm';
          btn.textContent = 'Entrar';
          btn.onclick = ()=> authModal.classList.remove('hidden');
          targetEl.appendChild(btn);
        }
      };

      if(currentUser && pinOK && profileName){
        bars.forEach(renderLogged);
        addItemCard.classList.remove('hidden');
      }else{
        renderAnon(authBarDesktop);
        renderAnon(authBarMobile);
        addItemCard.classList.add('hidden');
      }
    }

    // Modal mobile
    closeLoginBtn?.addEventListener('click',()=> authModal.classList.add('hidden'));
    doLoginBtn?.addEventListener('click', async ()=>{
      const n = (nameModal.value||'').trim();
      const p = norm(pinModal.value);
      if(!n){ alert('Digite seu nome'); return; }
      if(p !== norm(EVENT.familyPIN)){ alert('PIN incorreto'); return; }
      doLoginBtn.disabled = true; doLoginBtn.textContent = 'Entrando...';
      try{
        await signInAnonymously(auth);
        profileName = n; pinOK = true;
        localStorage.setItem('profileName',profileName);
        localStorage.setItem('pinOK','true');
        authModal.classList.add('hidden');
        renderAuthBars();            // <- atualiza topo no mobile
      }catch(e){ console.error(e); alert('Erro ao entrar'); }
      doLoginBtn.disabled = false; doLoginBtn.textContent = 'Entrar';
    });

    onAuthStateChanged(auth, (u)=>{ currentUser = u; renderAuthBars(); });

    // ===== Admin Panel
    function renderAdminPanel(){
      adminPanel.classList.toggle('hidden', !isAdmin);
      if(!isAdmin) return;
      // preencher campos
      cfgLocation.value = EVENT.location||'';
      cfgNotes.value    = EVENT.notes||'';
      cfgCols.value     = String(EVENT.giftsCols||2);
      cfgFamilyPIN.value= EVENT.familyPIN||'';
      cfgAdminPIN.value = EVENT.adminPIN||'';
    }

    saveCfg.onclick = async ()=>{
      await setDoc(eventDocRef, {
        location: cfgLocation.value||'',
        notes: cfgNotes.value||'',
        giftsCols: parseInt(cfgCols.value||'2',10)
      }, { merge:true });
    };
    savePins.onclick = async ()=>{
      await setDoc(eventDocRef, {
        familyPIN: cfgFamilyPIN.value||EVENT.familyPIN,
        adminPIN:  cfgAdminPIN.value||EVENT.adminPIN
      }, { merge:true });
    };
    addGift.onclick = async ()=>{
      const t = (giftTitle.value||'').trim();
      const q = parseInt(giftQty.value||'1',10);
      if(!t) return;
      await addDoc(giftsCol, { title:t, qty:q, reservedByName:null, deleted:false, createdAt: serverTimestamp() });
      giftTitle.value=''; giftQty.value='1';
    };

    // ===== Render helpers (cards)
    function itemCard(docId, d){
      const owner = d.ownerName || 'Fam√≠lia';
      const qty   = d.qty ? `${d.qty} ${d.unit||''}`.trim() : '';
      const isMine= currentUser && d.ownerUid===currentUser.uid;
      const canRemove = isMine || isAdmin;
      return `
        <div class="card p-4">
          <div class="flex items-start gap-3">
            <div class="w-10 h-10 rounded-full bg-blue-100 flex items-center justify-center font-semibold text-blue-700">${escapeHtml(owner[0]||'?')}</div>
            <div class="flex-1">
              <div class="flex items-center justify-between">
                <div>
                  <div class="text-sm text-gray-500">${escapeHtml(owner)}</div>
                  <div class="text-lg font-semibold">${escapeHtml(d.name)}</div>
                </div>
                ${qty?`<div class="text-xs px-2 py-1 rounded-full bg-gray-100">${escapeHtml(qty)}</div>`:''}
              </div>
              ${d.notes?`<div class="text-xs text-gray-500 mt-1">${escapeHtml(d.notes)}</div>`:''}
              ${canRemove?`<div class="mt-3"><button data-del="${docId}" class="btn btn-ghost text-xs">Remover</button></div>`:''}
            </div>
          </div>
        </div>
      `;
    }

    function giftCard(docId,g){
      const reserved = !!g.reservedByName;
      const who = reserved? `por <strong>${escapeHtml(g.reservedByName)}</strong>` : 'dispon√≠vel';
      const btnReserve = reserved ? '' : `<button data-reserve="${docId}" class="btn btn-primary text-xs">Vou levar</button>`;
      const btnFree = (reserved && isAdmin) ? `<button data-free="${docId}" class="btn btn-ghost text-xs">Liberar</button>` : '';
      return `
        <div class="card p-3 flex items-center justify-between">
          <div>
            <div class="font-medium">${escapeHtml(g.title)}</div>
            <div class="text-xs text-gray-500">${g.qty?`Qtd: ${escapeHtml(String(g.qty))}`:''} <span class="${reserved?'text-green-700':'text-gray-500'} ml-2">${who}</span></div>
          </div>
          <div class="flex items-center gap-2">${btnReserve}${btnFree}</div>
        </div>
      `;
    }

    function adminGiftRow(id,g){
      return `
        <div class="card p-3 flex items-center justify-between">
          <div class="text-sm">
            <strong>${escapeHtml(g.title)}</strong> ${g.qty?`<span class="text-gray-500">(Qtd: ${g.qty})</span>`:''}
          </div>
          <button data-delgift="${id}" class="btn btn-ghost text-xs">Remover</button>
        </div>
      `;
    }

    // ===== C√°lculo e comportamento da rolagem capada dos PRESENTES
    function calcGridMaxHeight(container, visibleItems = 6.5) {
      const first = container.children[0];
      if (!first) return 0;
      const cardH = first.getBoundingClientRect().height;
      const styles = getComputedStyle(container);
      const gap = parseFloat(styles.rowGap || styles.gap || 0);

      const cols = Math.max(1, parseInt(container.dataset.cols || '2', 10));
      const fullRows = Math.floor(visibleItems / cols);
      const remainder = Math.max(0, visibleItems - (fullRows * cols)); // itens na √∫ltima linha parcial
      const fracRow = remainder > 0 ? remainder / cols : 0;

      const gaps = Math.max(0, fullRows - 1) + (fracRow > 0 ? 1 : 0);
      return (fullRows * cardH) + (fracRow * cardH) + (gaps * gap);
    }

    function updateGiftsFade() {
      if (!giftsList.classList.contains('overflow-auto')) {
        giftsFade.style.display = 'none';
        return;
      }
      const atBottom = giftsList.scrollTop + giftsList.clientHeight >= giftsList.scrollHeight - 1;
      giftsFade.style.display = atBottom ? 'none' : 'block';
    }

    function applyGiftsScrollCap() {
      const visible = 6.5; // mude aqui se quiser outro ‚Äúcorte‚Äù
      const manyItems = giftsList.children.length > Math.floor(visible);

      if (giftsExpanded || !manyItems) {
        giftsList.style.maxHeight = '';
        giftsList.classList.remove('overflow-auto','pr-2');
        toggleGiftsBtn.classList.add('hidden');
        giftsFade.style.display = 'none';
        return;
      }

      const maxH = calcGridMaxHeight(giftsList, visible);
      if (maxH > 0) {
        giftsList.style.maxHeight = Math.round(maxH) + 'px';
        giftsList.classList.add('overflow-auto','pr-2'); // pr-2: espa√ßo pro scrollbar
        toggleGiftsBtn.classList.remove('hidden');
        updateGiftsFade();
      }
    }

    toggleGiftsBtn.addEventListener('click', () => {
      giftsExpanded = !giftsExpanded;
      toggleGiftsBtn.textContent = giftsExpanded ? 'recolher' : 'ver todos';
      applyGiftsScrollCap();
    });

    giftsList.addEventListener('scroll', updateGiftsFade);
    window.addEventListener('resize', () => { if (!giftsExpanded) applyGiftsScrollCap(); });

    // ===== Rerender Lists from cache (para quando alterna admin)
    function rerenderLists(){
      // items
      itemsList.innerHTML = '';
      cacheItems.forEach(({id,data})=>{
        if(data.deleted) return;
        itemsList.insertAdjacentHTML('beforeend', itemCard(id,data));
      });
      // bind remove item
      itemsList.querySelectorAll('[data-del]').forEach(btn=>{
        btn.onclick = async ()=>{
          const id = btn.getAttribute('data-del');
          if(!confirm('Remover este item?')) return;
          await setDoc(doc(db,'events',EVENT.id,'bringItems',id), { deleted:true }, { merge:true });
        };
      });

      // gifts
      giftsList.innerHTML = '';
      adminGiftsList.innerHTML = '';
      cacheGifts.forEach(({id,data})=>{
        if(data.deleted) return;
        giftsList.insertAdjacentHTML('beforeend', giftCard(id,data));
        if(isAdmin) adminGiftsList.insertAdjacentHTML('beforeend', adminGiftRow(id,data));
      });

      // binds gifts
      giftsList.querySelectorAll('[data-reserve]').forEach(btn=>{
        btn.onclick = async ()=>{
          if(!(currentUser && pinOK && profileName)){ alert('Entre com seu nome e PIN.'); return; }
          const id = btn.getAttribute('data-reserve');
          await updateDoc(doc(db,'events',EVENT.id,'gifts',id),{
            reservedByName: profileName,
            reservedByUid: currentUser.uid,
            reservedAt: serverTimestamp()
          });
        };
      });
      giftsList.querySelectorAll('[data-free]').forEach(btn=>{
        btn.onclick = async ()=>{
          if(!isAdmin) { alert('Apenas anfitri√£o.'); return; }
          const id = btn.getAttribute('data-free');
          await updateDoc(doc(db,'events',EVENT.id,'gifts',id),{
            reservedByName: null, reservedByUid: null, reservedAt: null
          });
        };
      });
      adminGiftsList.querySelectorAll('[data-delgift]').forEach(btn=>{
        btn.onclick = async ()=>{
          if(!isAdmin) return;
          const id = btn.getAttribute('data-delgift');
          if(!confirm('Remover presente da lista?')) return;
          await updateDoc(doc(db,'events',EVENT.id,'gifts',id),{ deleted:true });
        };
      });

      // badges / progress
      itemsCountBadge.textContent = cacheItems.filter(x=>!x.data.deleted).length
        ? `${cacheItems.filter(x=>!x.data.deleted).length} item(ns) combinados`
        : '';

      const totalGifts = cacheGifts.filter(x=>!x.data.deleted).length;
      const doneGifts  = cacheGifts.filter(x=>!x.data.deleted && x.data.reservedByName).length;
      const pct = totalGifts? Math.round((doneGifts/totalGifts)*100) : 0;
      progressText.textContent = `${doneGifts} / ${totalGifts}`;
      progressBar.style.width = pct + '%';

      // aplica/atualiza a rolagem capada do grid de presentes
      applyGiftsScrollCap();
    }

    // ===== Live snapshots
    onSnapshot(query(itemsCol,orderBy('createdAt','desc')),(snap)=>{
      cacheItems = [];
      snap.forEach(ds => cacheItems.push({id: ds.id, data: ds.data()}));
      rerenderLists();
    });

    onSnapshot(giftsCol,(snap)=>{
      cacheGifts = [];
      snap.forEach(ds => cacheGifts.push({id: ds.id, data: ds.data()}));
      rerenderLists();
    });

    // Doc de configura√ß√µes do evento
    onSnapshot(eventDocRef, (ds)=>{
      if(ds.exists()){
        const cfg = ds.data();
        EVENT.location  = cfg.location ?? EVENT.location;
        EVENT.notes     = cfg.notes ?? EVENT.notes;
        EVENT.giftsCols = cfg.giftsCols ?? EVENT.giftsCols;
        EVENT.familyPIN = cfg.familyPIN ?? EVENT.familyPIN;
        EVENT.adminPIN  = cfg.adminPIN ?? EVENT.adminPIN;
        updateEventHeader();
        renderAdminPanel();
        applyGiftsScrollCap(); // se colunas mudarem, recalcula o corte
      }
    });

    // ===== Adicionar item
    addItemForm.addEventListener('submit', async (e)=>{
      e.preventDefault();
      if(!(currentUser && pinOK && profileName)){ alert('Entre com seu nome e PIN.'); return; }
      const name = document.getElementById('itemName').value.trim();
      const qty  = parseFloat(document.getElementById('itemQty').value || '');
      const unit = document.getElementById('itemUnit').value.trim();
      const notes= document.getElementById('itemNotes').value.trim();
      if(!name){ alert('Digite o item'); return; }
      await addDoc(itemsCol,{
        name, qty: isNaN(qty)?null:qty, unit, notes,
        ownerName: profileName, ownerUid: currentUser.uid,
        createdAt: serverTimestamp(), deleted:false
      });
      e.target.reset();
    });

    // ===== Seed inicial de presentes (somente se vazio)
    async function seedGiftsIfEmpty(){
      const snap = await getDocs(giftsCol);
      if(snap.empty){
        const gifts = [
          { title: '6 pratos fundos', qty: 6 },
          { title: '6 pratos rasos',  qty: 6 },
          { title: 'Copos para caf√©', qty: 6 },
          { title: 'Chaleira',        qty: 1 },
          { title: 'Panela de teflon',qty: 1 },
          { title: 'Len√ßol vi√∫vo',    qty: 1 },
          { title: 'Meia d√∫zia de colheres', qty: 6 },
          { title: 'Meia d√∫zia de facas',    qty: 6 },
          { title: 'Meia d√∫zia de garfos',   qty: 6 },
          { title: 'Panos de prato',  qty: 3 },
          { title: 'Toalha de mesa pequena (quadrada)', qty: 1 }
        ];
        await Promise.all(gifts.map(g => addDoc(giftsCol, { ...g, deleted:false, createdAt: serverTimestamp() })));
      }
    }
    seedGiftsIfEmpty();

    // Inicial
    renderAuthBars();
    renderAdminPanel();
  </script>

  <!-- Regras Firestore (cole em Firestore > Regras, se ainda n√£o colocou)
  rules_version = '2';
  service cloud.firestore {
    match /databases/{database}/documents {
      function isAuthed(){ return request.auth != null; }
      match /events/{eventId} {
        allow read: if true;
        allow write: if isAuthed(); // simples p/ fam√≠lia
        match /{col=**}/{docId} {
          allow read: if true;
          allow write: if isAuthed();
        }
      }
    }
  }
  -->
</body>
</html>
