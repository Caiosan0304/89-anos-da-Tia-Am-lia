<!DOCTYPE html>
<html lang="pt-br">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>89 anos da Tia Am√©lia üéâ | Churrasco Comunit√°rio</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <meta name="description" content="Organizador interativo do churrasco comunit√°rio da Tia Am√©lia (89). Reserve presentes, cadastre o que vai levar e acompanhe o progresso em tempo real." />
  <link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='.9em' font-size='90'>üéÇ</text></svg>">
  <style>
    .card { @apply rounded-2xl shadow-lg p-4 bg-white; }
    .btn { @apply rounded-xl px-4 py-2 font-medium shadow hover:shadow-md transition; }
    .btn-primary { @apply bg-blue-600 text-white hover:bg-blue-700; }
    .btn-ghost { @apply bg-white border border-gray-300 hover:bg-gray-50; }
    .tag { @apply text-xs px-2 py-1 rounded-full bg-gray-100; }
    .input { @apply w-full rounded-xl border border-gray-300 px-3 py-2 focus:ring-2 focus:ring-blue-400 focus:border-blue-400; }
  </style>
</head>
<body class="min-h-screen bg-gradient-to-b from-blue-50 via-white to-rose-50 text-gray-800">
  <header class="sticky top-0 z-30 bg-white/70 backdrop-blur border-b">
    <div class="max-w-6xl mx-auto px-4 py-3 flex items-center gap-3">
      <div class="text-2xl">üéâ</div>
      <div class="flex-1">
        <h1 class="text-lg sm:text-xl font-bold">89 anos da Tia Am√©lia</h1>
        <p id="eventDateText" class="text-sm text-gray-600"></p>
      </div>
      <div id="authArea" class="flex items-center gap-2"></div>
    </div>
  </header>

  <section class="max-w-6xl mx-auto px-4 mt-6">
    <div class="grid md:grid-cols-3 gap-4">
      <div class="md:col-span-2 card">
        <div class="flex items-center justify-between gap-3">
          <div>
            <h2 class="text-xl font-bold">Churrasco comunit√°rio</h2>
            <p class="text-sm text-gray-600">Cada um leva um pouquinho e todo mundo curte juntinho üíô</p>
          </div>
          <div class="text-right">
            <div class="text-xs text-gray-500">Contagem regressiva</div>
            <div id="countdown" class="text-2xl font-bold">--d --h --m</div>
          </div>
        </div>
        <div class="mt-4">
          <div class="flex items-center justify-between text-sm mb-2">
            <span class="font-medium">Progresso dos presentes confirmados</span>
            <span id="progressText" class="text-gray-600">0 / 0</span>
          </div>
          <div class="w-full bg-gray-200 rounded-full h-3">
            <div id="progressBar" class="bg-blue-600 h-3 rounded-full" style="width:0%"></div>
          </div>
        </div>
      </div>
      <div class="card">
        <h3 class="font-semibold mb-2">Informa√ß√µes r√°pidas</h3>
        <ul class="text-sm space-y-2">
          <li><span class="tag">Local</span> <span id="eventLocation">Casa da fam√≠lia</span></li>
          <li><span class="tag">Hor√°rio</span> <span id="eventTime">18h</span></li>
          <li><span class="tag">Dress code</span> Alegre & confort√°vel üòÑ</li>
          <li><span class="tag">Obs.</span> Leve amor, fome e boas hist√≥rias!</li>
        </ul>
      </div>
    </div>
  </section>

  <section class="max-w-6xl mx-auto px-4 mt-6">
    <div class="grid md:grid-cols-3 gap-4">
      <div class="md:col-span-2 card">
        <div class="flex items-center justify-between">
          <h2 class="text-lg font-bold">Quem leva o qu√™<\/h2>
          <span id="itemsCountTag" class="tag">0 itens combinados<\/span>
        <\/div>
        <div id="addItemCard" class="mt-3 hidden">
          <form id="addItemForm" class="grid sm:grid-cols-5 gap-2">
            <input id="itemName" class="input sm:col-span-2" placeholder="Ex.: Picanha" required />
            <input id="itemQty" class="input" placeholder="Qtd (ex.: 3)" type="number" min="0" step="0.1" />
            <input id="itemUnit" class="input" placeholder="Unid (kg, un, L)" />
            <input id="itemNotes" class="input sm:col-span-5" placeholder="Observa√ß√µes (opcional)" />
            <button class="btn btn-primary sm:col-span-1" type="submit">Adicionar</button>
          </form>
        </div>
        <div id="itemsList" class="mt-4 grid md:grid-cols-2 gap-3"></div>
      </div>

      <div class="card">
        <h2 class="text-lg font-bold">Presentes da Tia Am√©lia</h2>
        <p class="text-sm text-gray-600 mb-3">Clique em ‚Äúvou levar‚Äù para reservar e evitar duplicidade.</p>
        <div id="giftsList" class="grid grid-cols-1 sm:grid-cols-2 gap-2"><\/div>
      </div>
    </div>
  </section>

  <footer class="max-w-6xl mx-auto px-4 py-10 text-center text-xs text-gray-500">
    Feito com üíô por Caio ‚Äî hospedado no GitHub Pages
  </footer>

  <script type="module">
    // ===== EVENTO =====
    const EVENT = {
      id: 'tia-amelia-89',
      dateISO: '2025-08-23T18:00:00-03:00',
      location: 'Casa da fam√≠lia',
      timeText: '18h',
      familyPIN: 'AMELIA89',
      adminPIN: 'HOST2025'
    };

    // ===== FIREBASE CONFIG (j√° com seu projeto) =====
    const firebaseConfig = {
      apiKey: "AIzaSyBduTvLuvV1lrCn7_w12PF0KZ7S6sLMUnQ",
      authDomain: "niver-tia-amelia.firebaseapp.com",
      projectId: "niver-tia-amelia",
      storageBucket: "niver-tia-amelia.firebasestorage.app",
      messagingSenderId: "468653303944",
      appId: "1:468653303944:web:e64829e04eb3351b5f973d",
      measurementId: "G-F0K72Z00XB"
    };

    // ===== IMPORTS (SDK v10 ‚Äì leve/est√°vel) =====
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.4/firebase-app.js";
    import { getAuth, signInAnonymously, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/10.12.4/firebase-auth.js";
    import { getFirestore, collection, doc, addDoc, setDoc, getDocs, onSnapshot, serverTimestamp, query, orderBy, updateDoc } from "https://www.gstatic.com/firebasejs/10.12.4/firebase-firestore.js";

    // ===== APP =====
    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);

    // ===== DOM =====
    const authArea = document.getElementById('authArea');
    const addItemCard = document.getElementById('addItemCard');
    const itemsList = document.getElementById('itemsList');
    const giftsList = document.getElementById('giftsList');
    const itemsCountTag = document.getElementById('itemsCountTag');
    const eventDateText = document.getElementById('eventDateText');
    const progressText = document.getElementById('progressText');
    const progressBar = document.getElementById('progressBar');

    // ===== STATE =====
    let currentUser = null;
    let profileName = localStorage.getItem('profileName') || '';
    let pinOK = localStorage.getItem('pinOK') === 'true';
    let isAdmin = localStorage.getItem('isAdmin') === 'true';

    // ===== INFO DO EVENTO =====
    eventDateText.textContent = new Date(EVENT.dateISO).toLocaleString('pt-BR', { weekday:'long', day:'2-digit', month:'long', hour:'2-digit', minute:'2-digit' });

    function tickCountdown(){
      const now = new Date();
      const target = new Date(EVENT.dateISO);
      const diff = Math.max(0, target - now);
      const d = Math.floor(diff / (1000*60*60*24));
      const h = Math.floor((diff / (1000*60*60)) % 24);
      const m = Math.floor((diff / (1000*60)) % 60);
      document.getElementById('countdown').textContent = `${d}d ${h}h ${m}m`;
    }
    setInterval(tickCountdown, 20000); tickCountdown();

    // ===== HELPER =====
    function escapeHtml(s){ return s.replace(/[&<>"']/g, m=>({"&":"&amp;","<":"&lt;",">":"&gt;","\"":"&quot;","'":"&#39;"}[m])); }

    // ===== AUTH (nome + PIN + an√¥nimo) =====
    function renderAuth(){
      authArea.innerHTML = '';
      if(currentUser && pinOK && profileName){
        const wrap = document.createElement('div');
        wrap.className = 'flex items-center gap-2';
        wrap.innerHTML = `<span class="text-sm">Ol√°, <strong>${escapeHtml(profileName)}</strong>${isAdmin? ' <span class=\"tag bg-green-100 text-green-700\">Anfitri√£o</span>':''}</span>
          <button id="adminBtn" class="btn btn-ghost text-xs">${isAdmin? 'Sair do modo anfitri√£o':'Entrar como anfitri√£o'}</button>
          <button id="logoutBtn" class="btn btn-ghost text-xs">Sair</button>`;
        authArea.appendChild(wrap);
        document.getElementById('adminBtn').onclick = ()=>{
          if(isAdmin){ isAdmin = false; localStorage.removeItem('isAdmin'); renderAuth(); }
          else { const pin = prompt('PIN do anfitri√£o:'); if((pin||'').trim().toUpperCase() === EVENT.adminPIN.toUpperCase()){ isAdmin = true; localStorage.setItem('isAdmin','true'); renderAuth(); } else alert('PIN de anfitri√£o incorreto'); }
        };
        document.getElementById('logoutBtn').onclick = async ()=>{
          await signOut(auth); localStorage.clear(); profileName=''; pinOK=false; isAdmin=false;
        };
        addItemCard.classList.remove('hidden');
      } else {
        const wrap = document.createElement('div');
        wrap.className = 'flex items-center gap-2';
        wrap.innerHTML = `
          <input id="nameInput" class="input w-40" placeholder="Seu nome" value="${escapeHtml(profileName)}"/>
          <input id="pinInput" class="input w-32" placeholder="PIN" />
          <button id="enterBtn" class="btn btn-primary text-sm">Entrar</button>`;
        authArea.appendChild(wrap);
        document.getElementById('enterBtn').onclick = async ()=>{
          const n = document.getElementById('nameInput').value.trim();
          const p = (document.getElementById('pinInput').value||'').trim();
          if(!n){ alert('Digite seu nome'); return; }
          const enterBtn = document.getElementById('enterBtn');
          enterBtn.disabled = true; enterBtn.textContent = 'Entrando...';
          const pinNormalized = p.toUpperCase();
          if(pinNormalized !== EVENT.familyPIN.toUpperCase()){
            alert('PIN incorreto'); enterBtn.disabled=false; enterBtn.textContent='Entrar'; return; }
          try{
            await signInAnonymously(auth);
            profileName = n; pinOK = true;
            localStorage.setItem('profileName', profileName);
            localStorage.setItem('pinOK', 'true');
            renderAuth(); // atualiza sem recarregar
          }catch(e){
            console.error(e); alert('Erro ao entrar');
          }finally{
            enterBtn.disabled=false; enterBtn.textContent='Entrar';
          }
        };
        addItemCard.classList.add('hidden');
      }
    }
    onAuthStateChanged(auth, (u)=>{ currentUser=u; renderAuth(); });

    // ===== FIRESTORE REFS =====
    const itemsCol = collection(db, 'events', EVENT.id, 'bringItems');
    const giftsCol  = collection(db, 'events', EVENT.id, 'gifts');

    // ===== RENDER =====
    function itemCard(docId, d){
      const owner = d.ownerName || 'Fam√≠lia';
      const qty = d.qty ? `${d.qty} ${d.unit||''}`.trim() : '';
      const notes = d.notes ? `<div class='text-xs text-gray-500 mt-1'>${escapeHtml(d.notes)}</div>` : '';
      const isMine = currentUser && d.ownerUid === currentUser.uid;
      const canRemove = isMine || isAdmin;
      return `
        <div class="rounded-2xl border p-4 bg-white/80">
          <div class="flex items-start gap-3">
            <div class="w-10 h-10 rounded-full bg-blue-100 flex items-center justify-center font-semibold text-blue-700">${escapeHtml(owner[0]||'?')}</div>
            <div class="flex-1">
              <div class="flex items-center justify-between">
                <div>
                  <div class="text-sm text-gray-500">${escapeHtml(owner)}</div>
                  <div class="text-lg font-semibold">${escapeHtml(d.name)}</div>
                </div>
                <div class="text-right">${qty ? `<div class=\"tag\">${escapeHtml(qty)}</div>`:''}</div>
              </div>
              ${notes}
              <div class="flex gap-2 mt-3">${canRemove ? `<button data-del='${docId}' class="btn btn-ghost text-xs">Remover</button>`:''}</div>
            </div>
          </div>
        </div>`;
    }

    function giftRow(docId, g){
      const reserved = !!g.reservedByName;
      const who = reserved ? `por <strong>${escapeHtml(g.reservedByName)}</strong>` : 'dispon√≠vel';
      const btnReserve = reserved ? '' : `<button data-reserve='${docId}' class="btn btn-primary btn-sm text-xs">Vou levar</button>`;
      const btnFree = (reserved && isAdmin) ? `<button data-free='${docId}' class="btn btn-ghost text-xs">Liberar</button>` : '';
      return `
        <div class="flex items-center justify-between rounded-xl border p-3 bg-white/80">
          <div>
            <div class="font-medium">${escapeHtml(g.title)}</div>
            <div class="text-xs text-gray-500">${g.qty?`Qtd: ${escapeHtml(String(g.qty))}`:''} <span class="ml-2 ${reserved?'text-green-700':'text-gray-500'}">${who}</span></div>
          </div>
          <div class="flex items-center gap-2">${btnReserve}${btnFree}</div>
        </div>`;
    }

    // ===== PROGRESS =====
    let totalDoneItems = 0, totalGifts = 0, totalReservedGifts = 0;
    function recomputeProgress(){
      // Agora a barra representa s√≥ o progresso dos PRESENTES
      const totalNeeded = totalGifts;
      const totalDone = totalReservedGifts;
      if (!totalNeeded) {
        progressText.textContent = '0 / 0';
        progressBar.style.width = '0%';
      } else {
        const pct = Math.min(100, Math.round((totalDone/totalNeeded)*100));
        progressText.textContent = `${totalDone} / ${totalNeeded}`;
        progressBar.style.width = pct + '%';
      }
    }

    // ===== LIVE: ITENS =====
    onSnapshot(query(itemsCol, orderBy('createdAt','desc')), (snap)=>{
      itemsList.innerHTML = '';
      let countItems = 0;
      snap.forEach(docSnap=>{
        const d = docSnap.data();
        if(d.deleted) return;
        countItems++;
        itemsList.insertAdjacentHTML('beforeend', itemCard(docSnap.id, d));
      });
      totalDoneItems = countItems;
      if (itemsCountTag) itemsCountTag.textContent = countItems + (countItems === 1 ? ' item combinado' : ' itens combinados');
      recomputeProgress();
      itemsList.querySelectorAll('[data-del]').forEach(btn=>{
        btn.addEventListener('click', async ()=>{
          const id = btn.getAttribute('data-del');
          if(!confirm('Remover este item?')) return;
          await setDoc(doc(db,'events',EVENT.id,'bringItems',id), { deleted: true }, { merge: true });
        });
      });
    });

    // ===== LIVE: PRESENTES =====
    onSnapshot(query(giftsCol, orderBy('title')), (snap)=>{
      giftsList.innerHTML = '';
      totalGifts = 0; totalReservedGifts = 0;
      snap.forEach(docSnap=>{
        const g = docSnap.data();
        if(g.deleted) return;
        totalGifts++;
        if(g.reservedByName) totalReservedGifts++;
        giftsList.insertAdjacentHTML('beforeend', giftRow(docSnap.id, g));
      });
      recomputeProgress();
      giftsList.querySelectorAll('[data-reserve]').forEach(btn=>{
        btn.addEventListener('click', async ()=>{
          if(!(currentUser && pinOK && profileName)) { alert('Entre com seu nome e PIN.'); return; }
          const id = btn.getAttribute('data-reserve');
          await updateDoc(doc(db,'events',EVENT.id,'gifts',id),{
            reservedByName: profileName,
            reservedByUid: currentUser.uid,
            reservedAt: serverTimestamp()
          });
        });
      });
      giftsList.querySelectorAll('[data-free]').forEach(btn=>{
        btn.addEventListener('click', async ()=>{
          if(!isAdmin){ alert('Apenas anfitri√£o.'); return; }
          const id = btn.getAttribute('data-free');
          await updateDoc(doc(db,'events',EVENT.id,'gifts',id),{
            reservedByName: null,
            reservedByUid: null,
            reservedAt: null
          });
        });
      });
    });

    // ===== ADD ITEM =====
    document.getElementById('addItemForm').addEventListener('submit', async (e)=>{
      e.preventDefault();
      if(!(currentUser && pinOK && profileName)) { alert('Entre com seu nome e PIN.'); return; }
      const name = document.getElementById('itemName').value.trim();
      const qty = parseFloat(document.getElementById('itemQty').value || '');
      const unit = document.getElementById('itemUnit').value.trim();
      const notes = document.getElementById('itemNotes').value.trim();
      if(!name){ alert('Digite o item'); return; }
      await addDoc(itemsCol, {
        name, qty: isNaN(qty)? null: qty, unit, notes,
        ownerName: profileName, ownerUid: currentUser.uid,
        createdAt: serverTimestamp(), deleted: false
      });
      e.target.reset();
    });

    // ===== SEED INICIAL DE PRESENTES =====
    async function seedGiftsIfEmpty(){
      const snap = await getDocs(giftsCol);
      if(snap.empty){
        const gifts = [
          { title: 'Toalha de mesa pequena (quadrada)', qty: 1 },
          { title: 'Copos para caf√©', qty: 6 },
          { title: 'Chaleira', qty: 1 },
          { title: 'Panela de teflon', qty: 1 },
          { title: 'Len√ßol vi√∫vo', qty: 1 },
          { title: 'Meia d√∫zia de garfos', qty: 6 },
          { title: 'Meia d√∫zia de colheres', qty: 6 },
          { title: 'Meia d√∫zia de facas', qty: 6 },
          { title: 'Panos de prato', qty: 3 },
          { title: '6 pratos fundos', qty: 6 },
          { title: '6 pratos rasos', qty: 6 },
        ];
        await Promise.all(gifts.map((g,i)=> setDoc(doc(giftsCol, String(i+1)), { ...g })));
      }
    }
    seedGiftsIfEmpty();
  </script>

  <!-- Regras Firestore (cole em Firestore > Regras)
  rules_version = '2';
  service cloud.firestore {
    match /databases/{database}/documents {
      function isAuthed(){ return request.auth != null; }
      match /events/{eventId} {
        allow read: if true;
        match /{col=**}/{docId} {
          allow read: if true;
          allow create, update: if isAuthed();
        }
      }
    }
  }
  -->
</body>
</html>
